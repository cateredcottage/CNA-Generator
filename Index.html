<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Catered Cottage ‚Äî CNA Assignment Generator</title>
  <style>
    :root{
      --bg1:#0b1220; --bg2:#f6f7fb;
      --card:#ffffff; --card2: rgba(255,255,255,.92);
      --ink:#0f172a; --muted:#64748b;
      --line: rgba(15,23,42,.10);
      --shadow: 0 12px 35px rgba(2,6,23,.14);
      --shadow2: 0 8px 18px rgba(2,6,23,.10);
      --r: 18px;
      --accent:#22c55e; --accent2:#2563eb;
      --chipbg: rgba(255,255,255,.10); --chipline: rgba(255,255,255,.14);
      --occ-bg: rgba(34,197,94,.16); --occ-br: rgba(34,197,94,.38);
      --obs-bg: rgba(245,158,11,.16); --obs-br: rgba(245,158,11,.40);
      --adm-bg: rgba(59,130,246,.16); --adm-br: rgba(59,130,246,.40);
      --hosp-bg: rgba(14,165,233,.16); --hosp-br: rgba(14,165,233,.40);
      --empty-bg: rgba(239,68,68,.14); --empty-br: rgba(239,68,68,.42);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--ink);
      background:
        radial-gradient(1100px 560px at 15% 0%, rgba(37,99,235,.35), transparent 60%),
        radial-gradient(1000px 700px at 90% 20%, rgba(34,197,94,.25), transparent 60%),
        linear-gradient(180deg, var(--bg1) 0%, var(--bg1) 24%, var(--bg2) 24%, var(--bg2) 100%);
    }
    .topbar{
      position:sticky; top:0; z-index:60;
      backdrop-filter: blur(12px);
      background: rgba(11,18,32,.78);
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .top-inner{
      max-width:1240px; margin:0 auto;
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between;
      gap:14px; flex-wrap:wrap;
      position:relative;
    }
    .brand{ display:flex; align-items:center; gap:12px; color:#fff; min-width:280px; }
    .brand .logoWrap{
      width:46px; height:46px; border-radius:50%; overflow:hidden;
      border:1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.08);
      box-shadow: 0 10px 25px rgba(0,0,0,.22);
      display:grid; place-items:center;
      flex: 0 0 auto;
    }
    .brand img{ width:46px; height:46px; object-fit:cover; display:block; }
    .brand .titles{ line-height:1.1; }
    .brand .titles b{ display:block; font-size:14px; letter-spacing:.2px; }
    .brand .titles span{ display:block; font-size:12px; opacity:.86; }

    .brand .titles .byline{
      display:block;
      font-size:11px;
      opacity:.75;
      margin-top:6px;
      letter-spacing:.15px;
    }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px; border-radius:999px;
      color: rgba(255,255,255,.92);
      background: var(--chipbg); border: 1px solid var(--chipline);
      font-size:12px; white-space:nowrap;
    }
    .chip strong{ color:#fff; font-weight:800; }
    .wrap{ max-width:1240px; margin:0 auto; padding:18px 16px 28px; }
    .panel{
      margin-top:6px;
      background: var(--card2);
      border: 1px solid rgba(255,255,255,.38);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .controls{
      padding:14px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.92));
      display:grid;
      grid-template-columns: 1.1fr 1.1fr 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 980px){ .controls{ grid-template-columns:1fr; } }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, select, button{ font:inherit; }
    input, select{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.14);
      background:#fff;
      outline:none;
      box-shadow: 0 1px 0 rgba(2,6,23,.05);
    }
    input:focus, select:focus{
      border-color: rgba(37,99,235,.45);
      box-shadow: 0 0 0 4px rgba(37,99,235,.15);
    }
    .btnrow{ display:flex; gap:8px; flex-wrap:wrap; }
    button{
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.14);
      background:#fff;
      cursor:pointer;
      box-shadow: 0 2px 10px rgba(2,6,23,.06);
      transition: transform .05s ease;
    }
    button:active{ transform: translateY(1px); }
    button.primary{
      border-color:transparent;
      color:#fff;
      background: linear-gradient(135deg, var(--accent2), var(--accent));
      box-shadow: 0 12px 26px rgba(37,99,235,.22);
    }
    button.ghost{ background: rgba(15,23,42,.04); }
    button.danger,
    #coverageClear{
      background: rgba(220,38,38,.10);
      border: 1px solid rgba(220,38,38,.45);
      color: rgba(185,28,28,1);
    }
    button.danger:hover:not(:disabled),
    #coverageClear:hover:not(:disabled){ background: rgba(220,38,38,.16); }
    button.danger:active:not(:disabled),
    #coverageClear:active:not(:disabled){ transform: translateY(1px); }
    button.danger:disabled,
    #coverageClear:disabled{ opacity:.55; }

    button:disabled{ opacity:.55; cursor:not-allowed; }
    .pillBtn{
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(15,23,42,.03);
      font-size:12px;
    }
    .helper{ margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35; }
    .legend{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; font-size:12px; color:var(--muted); }
    .lg{ display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid rgba(15,23,42,.10); background: rgba(15,23,42,.03); }
    .dot{ width:12px; height:12px; border-radius:3px; border:1px solid rgba(15,23,42,.12); }
    .dot.occ{ background: var(--occ-bg); border-color: var(--occ-br); }
    .dot.obs{ background: var(--obs-bg); border-color: var(--obs-br); }
    .dot.adm{ background: var(--adm-bg); border-color: var(--adm-br); }
    .dot.hosp{ background: var(--hosp-bg); border-color: var(--hosp-br); }
    .dot.empty{ background: var(--empty-bg); border-color: var(--empty-br); }

    .main{ padding:12px; background: rgba(246,247,251,.65); }
    .split{ display:grid; grid-template-columns: 540px 1fr; gap:12px; align-items:start; }
    @media (max-width: 1200px){ .split{ grid-template-columns: 500px 1fr; } }
    @media (max-width: 980px){ .split{ grid-template-columns: 1fr; } }

    .card{
      background: var(--card);
      border: 1px solid rgba(15,23,42,.10);
      border-radius: var(--r);
      box-shadow: var(--shadow2);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:260px;
    }
    .cardHead{
      padding:12px 14px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.92));
    }
    .cardHead h2{ margin:0; font-size:14px; }
    .sub{ margin-top:6px; font-size:12px; color:var(--muted); line-height:1.35; }
    .scroll{ overflow:auto; -webkit-overflow-scrolling: touch; flex:1 1 auto; }

    .editWrap{ padding:12px; display:grid; gap:10px; }
    .quickLegend{ display:flex; gap:8px; flex-wrap:wrap; }
    .miniBtn{
      padding:7px 10px; border-radius:999px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(15,23,42,.03);
      font-size:12px; cursor:pointer; white-space:nowrap;
    }
    .miniBtn:hover{ background: rgba(15,23,42,.06); }
    .miniBtn b{ font-weight:900; }
    .editGrid{ display:grid; grid-template-columns: 145px 1fr; gap:10px; align-items:start; }
    .roomList{
      border:1px solid rgba(15,23,42,.10);
      border-radius:14px; overflow:hidden; background:#fff;
      max-height: 380px;
    }
    .roomListHead{
      padding:10px; font-size:12px; color:var(--muted);
      border-bottom:1px solid rgba(15,23,42,.08);
      background:#fbfcff;
      position:sticky; top:0; z-index:3;
    }
    .roomListScroll{ max-height: 340px; overflow:auto; }
    .roomBtn{
      width:100%;
      text-align:left;
      padding:9px 10px;
      border:none;
      border-bottom:1px solid rgba(15,23,42,.06);
      background:#fff;
      cursor:pointer;
      font-size:13px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .roomBtn:hover{ background: rgba(37,99,235,.05); }
    .roomBtn.active{
      background: rgba(37,99,235,.10);
      outline:2px solid rgba(37,99,235,.20);
      outline-offset:-2px;
    }
    .roomBadges{ display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }
    .badge{
      font-size:11px;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.03);
      color:var(--muted);
      white-space:nowrap;
    }
    .badge.occ{ background: var(--occ-bg); border-color: var(--occ-br); color:#0f172a; }
    .badge.obs{ background: var(--obs-bg); border-color: var(--obs-br); color:#0f172a; }
    .badge.adm{ background: var(--adm-bg); border-color: var(--adm-br); color:#0f172a; }
    .badge.hosp{ background: var(--hosp-bg); border-color: var(--hosp-br); color:#0f172a; }
    .badge.empty{ background: var(--empty-bg); border-color: var(--empty-br); color:#0f172a; }

    .roomEditor{
      border:1px solid rgba(15,23,42,.10);
      border-radius:14px; overflow:hidden; background:#fff;
    }
    .roomEditorHead{
      padding:10px 10px 9px;
      border-bottom:1px solid rgba(15,23,42,.08);
      background:#fbfcff;
      display:flex; justify-content:space-between; align-items:flex-start;
      gap:10px; flex-wrap:wrap;
    }
    .roomEditorHead b{ font-size:13px; }
    .roomEditorHead b{ max-width: 100%; word-break: break-word; }
    .roomEditorBody{ padding:10px; display:grid; gap:10px; }

    .bedRow{
      display:grid;
      grid-template-columns: 52px 1fr;
      gap:10px; align-items:center;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(15,23,42,.10);
      background:#fff;
    }
    .bedLabel{ font-weight:900; font-size:12px; color:var(--muted); }
    .bedRow.occ{ background: var(--occ-bg); border-color: var(--occ-br); }
    .bedRow.obs{ background: var(--obs-bg); border-color: var(--obs-br); }
    .bedRow.adm{ background: var(--adm-bg); border-color: var(--adm-br); }
    .bedRow.hosp{ background: var(--hosp-bg); border-color: var(--hosp-br); }
    .bedRow.empty{ background: var(--empty-bg); border-color: var(--empty-br); }

    .inlineRow{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .inlineRow select{ min-width: 320px; }
    @media (max-width: 1200px){ .inlineRow select{ min-width: 300px; } }
    @media (max-width: 980px){ .inlineRow select{ min-width: 100%; } }

    .roomQuick{ display:flex; gap:8px; flex-wrap:wrap; }

    .rightWrap{ padding:12px 14px 14px; display:grid; gap:10px; }
    .sectionTitle{
      font-size:12px; color:var(--muted); letter-spacing:.2px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
    }
    .copyBar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    .tiny{
      padding:7px 10px; border-radius:999px; font-size:12px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(15,23,42,.03);
      cursor:pointer;
    }
    .tiny.primary{
      border-color:transparent; color:#fff;
      background: linear-gradient(135deg, var(--accent2), var(--accent));
      box-shadow: 0 10px 20px rgba(37,99,235,.18);
    }
    .box{ border:1px solid rgba(15,23,42,.10); border-radius:16px; padding:12px; background:#fff; }
    .boxHead{ display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    .boxHead h3{ margin:0; font-size:14px; }
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:999px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(15,23,42,.03);
      font-size:12px; color:var(--muted);
      white-space:nowrap;
    }
    .rows{ margin-top:6px; display:grid; gap:8px; }
    .run{ font-size:12px; color:var(--muted); }
    .line{ font-size:13px; }
    .line small{ color:var(--muted); }

    .toast{
      position:fixed; left:50%; bottom:18px;
      transform: translateX(-50%);
      background: rgba(15,23,42,.92);
      color:#fff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      box-shadow: 0 18px 40px rgba(0,0,0,.25);
      opacity:0;
      pointer-events:none;
      transition: opacity .15s ease, transform .15s ease;
      z-index:90;
    }
    .toast.show{ opacity:1; transform: translateX(-50%) translateY(-4px); }


    /* Print helpers */
    .printOnly{ display:none; }
    .roomChecklist{ margin-top:6px; }
    .roomChecklistTitle{ font-size:12px; font-weight:800; margin-bottom:6px; }
    .roomChecklistGrid{
      display:grid;
      grid-template-columns: repeat(6, minmax(0,1fr));
      gap:6px 10px;
      font-size:12px;
      line-height:1.2;
    }
    .rcItem{ display:flex; align-items:center; gap:6px; }
    .rcBox{ width:12px; height:12px; border:1px solid #000; display:inline-block; }
    .rcNum{ font-weight:700; }


    /* Print */
    #printHeader{ display:none; padding:12px 0 10px; border-bottom:2px solid #000; margin-bottom:10px; }
    #printHeader .phTop{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    #printHeader .phLeft{ display:flex; align-items:center; gap:12px; }
    #printHeader .phLogo{ width:72px; height:72px; border:1px solid #000; border-radius:50%; overflow:hidden; display:grid; place-items:center; background:#fff; }
    #printHeader .phLogo img{ width:140%; height:140%; object-fit:cover; object-position:center; transform:translate(-24%, -5%); }
    #printHeader h1{ margin:0; font-size:14px; letter-spacing:.2px; }
    #printHeader .meta{ margin-top:6px; font-size:12px; color:#111; }
    #printHeader .phRight{ text-align:right; font-size:12px; color:#111; line-height:1.3; white-space:nowrap; }

    @media print{
      .printOnly{ display:block !important; }
      .cnaDetails{ display:block !important; }
      body.printNoDetails .cnaDetails{ display:none !important; }
      .cnaBox.compact .cnaDetails{ display:block !important; }
      body.printNoDetails .cnaDetails{ display:none !important; }

      .topbar, .controls, .leftCol, .copyBar, .tiny, .toast { display:none !important; }
      body{ background:#fff !important; color:#000 !important; }
      .wrap{ padding:0 !important; max-width:none !important; }
      .panel{ box-shadow:none !important; border:none !important; background:#fff !important; margin:0 !important; }
      .main{ padding:0 !important; background:#fff !important; }
      #printHeader{ display:block !important; }
      .box{ break-inside: avoid; page-break-inside: avoid; }
      body.print-one-per .box.cnaBox{ break-after: page; page-break-after: always; }
      body.print-one-per .box.cnaBox:last-of-type{ break-after:auto; page-break-after:auto; }
    }

    /* Error banner */
    .err{
      display:none;
      margin: 0 0 10px 0;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.10);
      color: #7f1d1d;
      font-size: 12px;
      line-height: 1.35;
    }
    .err.show{ display:block; }

    /* Manual copy modal */
    .modalBack{
      position:fixed; inset:0; background: rgba(2,6,23,.55);
      display:none; align-items:center; justify-content:center;
      padding:18px; z-index:120;
    }
    .modalBack.show{ display:flex; }
    .modal{ width:min(900px, 96vw); background:#fff; border-radius:18px; border:1px solid rgba(15,23,42,.12); box-shadow: 0 30px 80px rgba(0,0,0,.35); overflow:hidden; }
    .modalTop{ padding:12px 14px; border-bottom:1px solid rgba(15,23,42,.10); display:flex; align-items:center; justify-content:space-between; gap:10px; background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.92)); }
    .modalTop b{ font-size:14px; }
    .modalBody{ padding:12px 14px; }
    .modalBody textarea{
      width:100%; height:min(55vh, 520px);
      border-radius:14px; border:1px solid rgba(15,23,42,.14);
      padding:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px; outline:none;
    }
    .modalBtns{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; padding:12px 14px; border-top:1px solid rgba(15,23,42,.10); }
  
    /* Colored top chips */
    .chip.chipEmp{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.12); }
    .chip.chipEmp b, .chip.chipEmp span{ color:#fecaca; }
    .chip.chipOHP{ border-color: rgba(59,130,246,.35); background: rgba(59,130,246,.12); }
    .chip.chipOHP b, .chip.chipOHP span{ color:#bfdbfe; }
    .chip.chipOBS{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.12); }
    .chip.chipOBS b, .chip.chipOBS span{ color:#fde68a; }
    .chip.chipADM{ border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12); }
    .chip.chipADM b, .chip.chipADM span{ color:#bbf7d0; }
    .chip.chipLicensed{ border-color: rgba(255,255,255,.20); background: rgba(255,255,255,.08); }
    /* Make tappable chips feel clickable */
    #chipEmpWrap, #chipOHPWrap, #chipOBSWrap, #chipADMWrap{ cursor:pointer; user-select:none; }
    #chipEmpWrap:active, #chipOHPWrap:active, #chipOBSWrap:active, #chipADMWrap:active{ transform: translateY(1px); }


    .nameInput{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(15,23,42,.14);
      font-size:13px;
      outline:none;
    }
    .nameInput:focus{ border-color: rgba(37,99,235,.55); box-shadow: 0 0 0 3px rgba(37,99,235,.15); }
    @media(max-width:520px){
      #cnaNamesGrid{ grid-template-columns:1fr !important; }
    }


    .footerCredit{
      margin-top:6px;
      text-align:center;
      padding:14px 16px;
      color: rgba(255,255,255,.88);
      font-size:12px;
      background: rgba(11,18,32,.80);
      border-top: 1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
    }
    .footerCredit strong{
      color:#22c55e;
      font-weight:900;
      letter-spacing:.2px;
    }
    .footerCredit .mini{
      display:block;
      margin-top:6px;
      font-size:11px;
      opacity:.78;
    }



    


    /* Compact CNA cards (mobile-friendly) */
    .cnaToggle{
      border:1px solid rgba(15,23,42,.14);
      background:rgba(15,23,42,.03);
      border-radius:999px;
      padding:6px 10px;
      cursor:pointer;
      font-size:12px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .cnaToggle .car{ opacity:.75; }
    .cnaSummary{ color:var(--muted); font-size:12px; margin-top:6px; }
    .cnaBox.compact .cnaDetails{ display:none; }
    .cnaBox.compact.open .cnaDetails{ display:block; }
    /* Allow collapsing CNA room details on desktop too */
    .cnaBox:not(.open) .cnaDetails{ display:none; }



/* Mobile: collapse the top stat chips to save space */
.top-chips-details { margin-top:6px; }
.top-chips-summary {
  list-style: none;
  display: inline-flex;
  align-items: center;
  gap: 10px;
  padding: 10px 14px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.18);
  background: rgba(255,255,255,0.08);
  color: rgba(255,255,255,0.92);
  font-weight: 700;
  cursor: pointer;
  user-select: none;
}
.top-chips-summary::-webkit-details-marker { display: none; }
.top-chips-summary .icon { font-size: 16px; line-height: 1; }
.top-chips-summary .label { letter-spacing: 0.2px; }

/* On larger screens, keep chips always visible and hide the summary toggle */
@media (min-width: 761px){
  .top-chips-summary { display: none; }
  .top-chips-details { display: block; }
}

/* When collapsed, add a bit more breathing room below header */
@media (max-width: 760px){
  /* Put the toggle on the top-right so it doesn't take a full row */
  .top-chips-summary{
    position:absolute;
    right:16px;
    top:14px;
    padding:8px 10px;
    gap:8px;
  }
  .top-chips-summary .label{ display:none; } /* icon-only on mobile */
  .top-chips-details{ margin-top:0; }
  .top-chips-details:not([open]) { margin-bottom: 10px; }
  .top-chips-details[open] .chips { margin-top:6px; }
}


    /* ===== Compact + cleaner mobile UI ===== */
    @media (max-width: 760px){
      body{ font-size:14px; }
      .wrap{ padding: 10px !important; }
      .card{ padding: 12px !important; border-radius: 16px !important; }
      .btnrow{ gap: 8px !important; }
      button, .btn, select, input[type="text"]{ font-size: 14px !important; }
      button{ padding: 10px 12px !important; }
      .helper{ font-size: 12px !important; }
      /* Reduce heavy shadows on mobile to feel snappier */
      .card{ box-shadow: 0 6px 14px rgba(2,6,23,.10) !important; }
      /* Make room list show more items */
      .roomListScroll{ max-height: 65vh !important; -webkit-overflow-scrolling: touch; }
      /* Keep the chips row compact */
      .statsWrap{ gap: 6px !important; }
      .statChip{ padding: 6px 10px !important; font-size: 12px !important; }
    }

  
/* Print logo: keep full mark visible */
@media print{
  #printHeader .phLogo{ width:76px; height:76px; }
  #printHeader h1{ font-size:14px; }
}


/* Hide Spread Rooms (auto-balance) option */
#spreadRooms, label[for="spreadRooms"]{ display:none !important; }


/* ===== Print header logo (uniform circle, no cut edges) ===== */
#printHeader .phLogo{
  background-color:#f7f5ef;            /* uniform fill behind logo */
  background-repeat:no-repeat;
  background-position:55% 50%;         /* tune left/right here */
  background-size:135%;                /* zoom level */
  -webkit-print-color-adjust: exact;
  print-color-adjust: exact;
}
#printHeader .phLogo img{
  width:100%;
  height:100%;
  opacity:0;                           /* keep for src; hide visually */
  pointer-events:none;
}

/* Print-only polish */
@media print{
  @page{ margin: 12mm; }
  html, body{
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
  #printHeader{
    break-inside: avoid;
    page-break-inside: avoid;
  }
  #printHeader .phLogo{
    background-position:55% 50%;       /* slightly more left in print */
    background-size:135%;              /* a touch more zoom for paper */
  }
}


@media print{
  #printHeader{ display:flex; align-items:center; gap:12px; }
  #printHeader .phText{ flex:1; min-width:0; }
  #printHeader .phText h1, #printHeader .phText h2{
    word-break:break-word;
  }
}


/* === PRINT: Make Room Range bold / underlined / uppercase (professional) === */
@media print{
  .cnaRange, .cnaSummary.cnaRange{
    font-weight: 800 !important;
    text-decoration: underline !important;
    text-transform: uppercase !important;
    letter-spacing: 0.6px !important;
    font-size: 13.5pt !important;
    margin: 6px 0 8px 0 !important;
    display: block !important;
  }
}


/* === PRINT: Room Range (clean) === */
@media print{
  .cnaRange, .cnaSummary.cnaRange{
    font-weight: 700 !important;
    text-decoration: underline !important;
    text-transform: none !important;
    letter-spacing: 0.2px !important;
    font-size: 12pt !important;
    color: #000 !important;
    margin: 6px 0 8px 0 !important;
    display: block !important;
  }
}


/* === Mobile action bar (Generate / Shuffle / Print) === */
.mobileActionBar{ display:none; }
@media (max-width: 820px){
  .mobileActionBar{
    position: fixed;
    left: 12px;
    right: 12px;
    bottom: 12px;
    display: flex;
    gap: 10px;
    padding: 10px;
    border-radius: 18px;
    background: rgba(255,255,255,0.92);
    border: 1px solid rgba(15,23,42,0.12);
    box-shadow: 0 10px 30px rgba(2,6,23,0.18);
    z-index: 9999;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  .mobileActionBar .mBtn{
    flex: 1 1 0;
    padding: 12px 10px;
    border-radius: 14px;
    font-weight: 700;
    border: 1px solid rgba(15,23,42,0.14);
    background: #fff;
  }
  .mobileActionBar .mPrimary{
    border: none;
    background: linear-gradient(135deg, #2563eb, #10b981);
    color: #fff;
  }
  .mobileActionBar .mGhost{
    color: #0f172a;
    background: rgba(255,255,255,0.75);
  }
  .mobileActionBar .mBtn:disabled{
    opacity: 0.45;
  }
  /* Give content room so the bar doesn't cover buttons/text */
  body{ padding-bottom: 92px; }
}
@media print{
  .mobileActionBar{ display:none !important; }
}

</style>

<style>
/* === Room Range Print Styling Enhancement === */
@media print {
  .range,
  .room-range,
  .range-text,
  .roomRange,
  .rangeLabel {
    font-weight: 700 !important;
    text-decoration: underline !important;
    text-transform: uppercase !important;
    letter-spacing: 0.6px !important;
  }
}
</style>


<style>
@media print {
  body {
    margin: 10mm !important;
    -webkit-print-color-adjust: exact;
  }
  h1, h2, h3 {
    font-size: 14px !important;
    font-weight: normal !important;
    margin: 4px 0 !important;
  }
  img {
    display: none !important;
  }
}
</style>

</head>
<body>
  <div class="topbar">
    <div class="top-inner">
      <div class="brand">
        <div class="logoWrap">
          CC</span>';">
        </div>
        <div class="titles">
          <b>Catered Cottage Healthcare</b>
          <span>CNA Assignment Generator</span>
          <span class="byline">Built by Arnold Deveney</span>
        </div>
      </div>

      <details id="topChipsDetails" class="top-chips-details" open>
        <summary id="topChipsSummary" class="top-chips-summary" aria-label="Toggle shift stats">
          <span class="icon">üìä</span><span class="label">Shift Stats</span>
        </summary>
<div class="chips" aria-live="polite">
        <div class="chip">Census: <strong id="chipCensus">0</strong></div>
        <div class="chip">CNA Workload: <strong id="chipWorkload">0</strong></div>
        <div class="chip chipOBS" id="chipOBSWrap" title="Tap to filter rooms with observation beds">On Observation: <strong id="chipObs">0</strong></div>
        <div class="chip chipADM" id="chipADMWrap" title="Tap to filter rooms with pending admissions">Pending Admission: <strong id="chipAdm">0</strong></div>
        <div class="chip">Rooms: <strong id="chipRooms">0</strong></div>
        <div class="chip chipEmp" id="chipEmpWrap" title="Tap to filter rooms with empty beds">Empty Beds: <span id="chipEMP">0</span></div>
        <div class="chip chipOHP" id="chipOHPWrap" title="Tap to filter rooms with Out to Hospital">Out to Hospital: <span id="chipOHP">0</span></div>
        <div class="chip">Auto-save: <strong id="saveStatus">Ready</strong></div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="panel">

      <div class="controls">
        <div>
          <label># of CNAs working</label>
          <input id="cnaCount" type="number" min="1" max="30" value="7" />
          <div class="helper">
            <b>Census</b> = Occupied + On Observation.<br/>
            <b>CNA Workload</b> = Occupied + Pending Admission.<br/>
            Beds marked <b>On Observation</b> do not count toward CNA workload.
          </div>
          <div class="legend" aria-hidden="true">
            <div class="lg"><span class="dot occ"></span> Occupied</div>
            <div class="lg"><span class="dot obs"></span> On Observation</div>
            <div class="lg"><span class="dot adm"></span> Pending Admission</div>
            <div class="lg"><span class="dot hosp"></span> Out to Hospital</div>
            <div class="lg"><span class="dot empty"></span> Empty</div>
          </div>
        </div>

        <div>
          <label>Find room/bed (quick search)</label>
          <input id="searchBox" type="text" placeholder="Example: 17, 17A, 28B..." />
          <div class="helper">Press Enter to jump to that room.</div>
        </div>

        <div>
          <label>Random totals (fair)</label>
          <div class="btnrow">
            <button class="pillBtn" id="toggleRandom">Randomize who gets +1: <b id="randState">ON</b></button>
          </div>
          <div class="helper">Avoids ‚Äúfirst CNAs always get more‚Äù.</div>
        </div>

        <div>
          <label>Generate / Print</label>

          
<div class="lightPanel" id="lightPanel">
  <button type="button" class="lpToggle" id="lightToggle" aria-expanded="false">
    <div class="lpLeft">
      <b>Light load (optional)</b>
      <span>Give specific CNAs 1‚Äì2 fewer patients</span>
    </div>
    <div class="lpRight">
      <span class="lpPill" id="lightPill">OFF</span>
      <span class="lpCaret" id="lightCaret">‚ñæ</span>
    </div>
  </button>

  <div class="lpBody" id="lightBody" hidden>
    <div class="helper" style="margin:0 0 10px 0;">
      Add only the CNAs who need a lighter load (more dependent residents). You can add 2‚Äì3 CNAs (or more).
    </div>

    <div class="lightRules" id="lightRules"></div>

    <div class="btnrow" style="margin-top:6px;">
      <button id="lightAdd" class="ghost" type="button">+ Add CNA</button>
      <button id="lightClear" class="ghost" type="button">Clear</button>
    </div>
  </div>
</div>


          <div class="btnrow">
            <button id="generate" class="primary">Generate</button>
            <button id="shuffleAgain" class="ghost" disabled>Shuffle Again</button>
            <button id="printBtn" class="ghost" disabled>Print Assignments</button>
          </div>

          <div class="btnrow" style="margin-top:6px;">
            <label class="chipToggle" style="display:flex;align-items:center;gap:8px;margin:0;padding:8px 10px;border-radius:14px;border:1px solid rgba(15,23,42,.12);background:rgba(15,23,42,.03);font-size:12px;color:var(--muted);">
              <input id="spreadRooms" type="checkbox" style="width:auto;margin:0;"/>
              Spread rooms (auto-balance)
            </label>
          </div>

          <div class="helper">Workload min/max/diff: <b id="loadStats">-</b></div>
        </div>

        

        <div>
          <label>Coverage change (CNA leaves early)</label>
          <div class="btnrow">
            <select id="absentCna" style="min-width:160px;">
              <option value="">Select CNA‚Ä¶</option>
            </select>
            <select id="coverageMode" style="min-width:240px;">
              <option value="order">Redistribute in order (minimal change)</option>
              <option value="least">Redistribute to least workload (more balanced)</option>
              <option value="reshuffle">Full reshuffle (new assignments)</option>
            </select>

            <label style="display:flex;align-items:center;gap:8px;margin:0;padding:8px 10px;border-radius:14px;border:1px solid rgba(15,23,42,.12);background:rgba(15,23,42,.03);font-size:12px;color:var(--muted);">
              <input id="keepClose" type="checkbox" checked style="width:auto;margin:0;"/>
              Keep rooms close (prefer nearest rooms)
            </label>

            <select id="fairnessMode" style="min-width:220px;">
              <option value="strict">Fairness A: Strict balance</option>
              <option value="soft">Fairness B: Soft (allow +1 to keep closer)</option>
            </select>
            <button id="applyCoverage" class="ghost" disabled>Apply</button>
            <button id="coverageUndo" class="ghost" disabled>Undo</button>
            <button id="coverageRedo" class="ghost" disabled>Redo</button>
            <button id="coverageClear" class="danger" disabled>Clear Coverage</button>
          </div>
          <div class="helper">Use this after you already generated assignments. It removes that CNA and fairly spreads their workload to the others (or reshuffles).</div>
        </div>

<div>
          <label>Print header fields</label>
          <div class="btnrow">
            <input id="printDate" type="date" />
            <select id="printShift">
              <option value="Day (7am-3pm)">Day (7am-3pm)</option>
              <option value="Evening (3pm-11pm)">Evening (3pm-11pm)</option>
              <option value="Night (11pm-7am)">Night (11pm-7am)</option>
            </select>
          </div>
          <div class="helper">These appear on the paper header.</div>
        </div>

        <div>
          <label>Print options</label>
          <div class="btnrow">
            <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:#0f172a;">
              <input id="onePerPage" type="checkbox" style="width:18px;height:18px;" />
              One CNA per page
            </label>
            <input id="printRoomList" type="checkbox" style="display:none" />
            <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:#0f172a;">
              <input id="printDetails" type="checkbox" checked style="width:18px;height:18px;" />
              Print CNA room details (Room X: beds)
            </label>
            <label style="display:flex;align-items:center;gap:8px;font-size:13px;color:#0f172a;">
              <input id="detailsDefault" type="checkbox" checked style="width:18px;height:18px;" />
              Show Details by default (mobile)
            </label>
          </div>
          <div class="helper">Good for handing assignments to staff.</div>
        </div>

        <div>
          <label>Filter rooms list</label>
          <select id="filterMode">
            <option value="all" selected>Show all rooms</option>
            <option value="hasCensus">Only rooms with census</option>
            <option value="hasObs">Only rooms with observation</option>
            <option value="hasAdm">Only rooms with pending admission</option>
            <option value="hasEmpty">Only rooms with empty beds</option>
            <option value="hasHosp">Only rooms with Out to Hospital</option>
          </select>
          <div class="helper">This affects the room list on the left.</div>
        </div>

        <div>
          <label>Legend</label>
          <div class="helper">AO = All Occupied ‚Ä¢ AE = All Empty ‚Ä¢ AObs = All Observation ‚Ä¢ AAdm = All Pending Admission ‚Ä¢ AOHP = All Out to Hospital</div>
        </div>
      
      </details>
</div>

      <div class="main">
        <div class="split">

          <div class="card leftCol">
            <div class="cardHead">
              <h2>Edit census (tap a room)</h2>
              <div class="sub">Use the room list to edit one room at a time. Fast + clean.</div>
              <div class="sub">Legend: <b>OBS</b> = On Observation (does not count toward CNA workload). <b>ADM</b> = Pending Admission (counts toward workload; not census).</div>
            </div>

            <div class="editWrap">
              <div id="errBox" class="err"></div>

              <div class="quickLegend">
                <button class="miniBtn" id="legendAO"><b>AO</b> All Occupied</button>
                <button class="miniBtn" id="legendAE"><b>AE</b> All Empty</button>
                <button class="miniBtn" id="legendAObs"><b>AObs</b> All Observation</button>
                <button class="miniBtn" id="legendAAdm"><b>AAdm</b> Pending Admission</button>
                              <button class="miniBtn" id="undoBtn" title="Undo last census change" disabled><b>Undo</b></button>
                <button class="miniBtn" id="redoBtn" title="Redo" disabled><b>Redo</b></button>
</div>

              <div class="editGrid">
                <div class="roomList">
                  <div class="roomListHead">Rooms</div>
                  <div class="roomListScroll" id="roomList"></div>
                </div>

                <div class="roomEditor">
                  <div class="roomEditorHead">
                    <b id="roomEditorTitle">Select a room</b>
                    <div class="roomQuick">
                      <button class="miniBtn" id="roomOcc" disabled>Room AO</button>
                      <button class="miniBtn" id="roomEmpty" disabled>Room AE</button>
                      <button class="miniBtn" id="roomObs" disabled>Room AObs</button>
                      <button class="miniBtn" id="roomAdm" disabled>Room AAdm</button>
                    </div>
                  </div>
                  <div class="roomEditorBody" id="roomEditorBody">
                    <div class="helper" style="margin:0;">Pick a room from the list to edit beds A/B/C.</div>
                  </div>
                </div>
              </div>

              <div class="helper" style="margin-top:0;">
                <b>Pending Admission</b> does <u>not</u> count toward census but <u>does</u> count toward CNA workload.
              </div>
            </div>
          </div>

          <div class="card">
            <div class="cardHead">
              <h2>CNA Assignments</h2>
              <div class="sub">Print includes CNA assignments + Observation List.</div>
            </div>

            <div class="scroll">
              <div class="rightWrap" id="printArea">

                <div id="printHeader">
                  <div class="phTop">
                    <div class="phLeft">
                      <div class="phLogo"></div>
                      <div>
                        <h1>Catered Cottage Healthcare ‚Äî CNA Assignments</h1>
                        <div class="meta">
                          Date: <b id="phDate">‚Äî</b> &nbsp; | &nbsp; Shift: <b id="phShift">‚Äî</b> &nbsp; | &nbsp; CNAs: <b id="phCnas">‚Äî</b>
                        </div>
                        <div class="meta">
                          Census: <b id="phCensus">‚Äî</b> &nbsp; | &nbsp; CNA Workload: <b id="phWorkload">‚Äî</b> &nbsp; | &nbsp;
                          On Observation: <b id="phObs">‚Äî</b> &nbsp; | &nbsp; Pending Admission: <b id="phAdm">‚Äî</b>
                        </div>
                      </div>
                    </div>
                    <div class="phRight"><div><b>Built by:</b> Arnold Deveney</div>
        Generated: <b id="phGenerated">‚Äî</b></div>
                  </div>
                </div>

                <div class="sectionTitle">
                  <span>CNA Assignments (Workload = Occupied + Pending Admission)</span>
                  <div class="copyBar">
                    <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted);">
                      <input id="copyIncludeObs" type="checkbox" style="width:16px;height:16px;">
                      Include Observation List
                    </label>
                    <button id="copyAllBtn" class="tiny primary" disabled>Copy All</button>
                    <button id="copyAllWordBtn" class="tiny" disabled>Copy All (Word)</button>
                    <button id="toggleAllDetailsBtn" class="tiny" disabled>Expand all</button>
                    <label style="display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted);">
                      <input id="copyPageBreaks" type="checkbox" style="width:16px;height:16px;">
                      Add page breaks for Word
                    </label>
                  </div>
                </div>

                <div id="assignments"><div style="color:#64748b;font-size:12px">(click Generate)</div></div>

                <div style="height:8px"></div>

                <div class="sectionTitle">
                  <span>Observation List (On Observation)</span>
                  <div class="copyBar"><button id="copyObsBtn" class="tiny" disabled>Copy Observation List</button></div>
                </div>

                <div id="obsSummary"><div style="color:#64748b;font-size:12px">(Observation beds appear after Generate)</div></div>


                <div class="card2" style="margin-top:6px;">
                  <div class="row" style="justify-content:space-between;align-items:center;margin:0 0 8px;">
                    <div class="sectionTitle">Out to Hospital</div>
                    <button id="copyHospBtn" class="tiny" disabled>Copy Hospital List</button>
                  </div>
                  <div id="hospList"><div style="color:#64748b;font-size:12px">(Beds marked ‚ÄúOut to Hospital‚Äù show here)</div></div>
                </div>


              </div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <div id="toast" class="toast">Copied!</div>

  <div class="modalBack" id="copyModal">
    <div class="modal">
      <div class="modalTop">
        <b>Clipboard blocked ‚Äî manual copy</b>
        <button class="tiny" id="closeModalBtn">Close</button>
      </div>
      <div class="modalBody">
        <div class="helper" style="margin:0 0 10px 0;">
          Click inside the box, press <b>Ctrl+A</b> then <b>Ctrl+C</b> (or long-press on phone ‚Üí Copy).
        </div>
        <textarea id="modalText"></textarea>
      </div>
      <div class="modalBtns">
        <button class="tiny primary" id="selectAllBtn">Select All</button>
        <button class="tiny" id="closeModalBtn2">Close</button>
      </div>
    </div>
  </div>

<script>
(function(){
  // --- Compatibility helpers (no optional chaining) ---
  function safeParseJSON(s){ try { return JSON.parse(s); } catch(e){ return null; } }
  function get(id){ return document.getElementById(id); }

  function escapeHtml(s){
    s = String(s == null ? "" : s);
    return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }

  function showError(msg){
    var box = get("errBox");
    if (!box) return;
    box.textContent = msg;
    box.classList.add("show");
  }

  window.addEventListener("error", function(ev){
    try{
      showError("App error: " + (ev && ev.message ? ev.message : "Unknown error") + " (rooms may not load).");
    }catch(e){}
  });

  // Rooms (16abc corrected)
  var THREE_BED_ROOMS = [1,2,3,5,6,7,8,9,10,11,12,14,15,16,17,18,19,20,21,22,23,24,25,26,27,29];
  var TWO_BED_ROOMS   = [4,28,30];

  var STATUS = ["Occupied", "On Observation", "Pending Admission", "Out to Hospital", "Empty"];
  var OBS_GROUPS = ["Unassigned","Observer 1","Observer 2","Observer 3","Observer 4","Observer 5","Observer 6","Observer 7","Observer 8","Observer 9","Observer 10"];
  var STORAGE_KEY = "cc_cna_roomlist_editor_v2";

  var saved = null;
  try{ saved = safeParseJSON(localStorage.getItem(STORAGE_KEY)); }catch(e){ saved = null; }

  function toast(msg){
    var t = get("toast");
    if (!t) return;
    t.textContent = msg || "Done";
    t.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(function(){ t.classList.remove("show"); }, 1100);
  }

  function openCopyModal(text){
    var back = get("copyModal");
    var ta = get("modalText");
    if (!back || !ta) return;
    ta.value = text || "";
    back.classList.add("show");
    setTimeout(function(){ ta.focus(); ta.select(); }, 50);
  }
  function closeCopyModal(){
    var back = get("copyModal");
    if (back) back.classList.remove("show");
  }
  get("closeModalBtn").addEventListener("click", closeCopyModal);
  get("closeModalBtn2").addEventListener("click", closeCopyModal);
  get("selectAllBtn").addEventListener("click", function(){
    var ta = get("modalText");
    ta.focus(); ta.select(); toast("Selected");
  });
  get("copyModal").addEventListener("click", function(e){
    if (e.target && e.target.id === "copyModal") closeCopyModal();
  });

  function setSaveStatus(text){
    var el = get("saveStatus");
    if (!el) return;
    el.textContent = text;
    clearTimeout(setSaveStatus._t);
    setSaveStatus._t = setTimeout(function(){ el.textContent = "Ready"; }, 1100);
  }

  function buildAllBeds(){
    var beds = [];
    for (var i=0;i<THREE_BED_ROOMS.length;i++){
      var r = THREE_BED_ROOMS[i];
      beds.push(String(r)+"A", String(r)+"B", String(r)+"C");
    }
    for (var j=0;j<TWO_BED_ROOMS.length;j++){
      var r2 = TWO_BED_ROOMS[j];
      beds.push(String(r2)+"A", String(r2)+"B");
    }
    beds.sort(function(a,b){
      var ra = parseInt(a,10), rb = parseInt(b,10);
      if (ra !== rb) return ra - rb;
      var la = a.slice(-1), lb = b.slice(-1);
      return la.localeCompare(lb);
    });
    return beds;
  }
  var ALL_BEDS = buildAllBeds();

  function roomsAll(){
    var set = {};
    for (var i=0;i<THREE_BED_ROOMS.length;i++) set[THREE_BED_ROOMS[i]] = true;
    for (var j=0;j<TWO_BED_ROOMS.length;j++) set[TWO_BED_ROOMS[j]] = true;
    var out = [];
    for (var k in set) out.push(parseInt(k,10));
    out.sort(function(a,b){ return a-b; });
    return out;
  }
  var ALL_ROOMS = roomsAll();

  function bedsForRoom(r){
    r = parseInt(r,10);
    if (THREE_BED_ROOMS.indexOf(r) >= 0) return [String(r)+"A", String(r)+"B", String(r)+"C"];
    if (TWO_BED_ROOMS.indexOf(r) >= 0) return [String(r)+"A", String(r)+"B"];
    return [];
  }
  function roomNum(bed){ return parseInt(bed,10); }

  // Sort beds like 4A, 4B, 4C, 5A... (works everywhere, including iPhone)
  function bedSort(a,b){
    var ra = roomNum(a);
    var rb = roomNum(b);
    if (ra !== rb) return ra - rb;
    // Compare suffix letters (A/B/C) if present
    var sa = (a+"").replace(/\d+/g,"");
    var sb = (b+"").replace(/\d+/g,"");
    if (sa < sb) return -1;
    if (sa > sb) return 1;
    return 0;
  }


  // State
  var bedStatus = {};
  var bedObsGroup = {};
  var randomizeTotals = true;
  var cnaNames = [];
  var cnaAdjust = [];
  var lightRules = [];

  // Undo/Redo history (beds + observation groups only)
  var history = [];
  var historyIndex = -1;
  var HISTORY_MAX = 80;

  function snapshotState(){
    var bs = {};
    var og = {};
    for (var i=0;i<ALL_BEDS.length;i++){
      var b = ALL_BEDS[i];
      bs[b] = bedStatus[b];
      og[b] = bedObsGroup[b];
    }
    return { bedStatus: bs, bedObsGroup: og, selectedRoom: selectedRoom };
  }

  function sameSnapshot(a,b){
    if (!a || !b) return false;
    if (a.selectedRoom !== b.selectedRoom) return false;
    for (var i=0;i<ALL_BEDS.length;i++){
      var k = ALL_BEDS[i];
      if (a.bedStatus[k] !== b.bedStatus[k]) return false;
      if (a.bedObsGroup[k] !== b.bedObsGroup[k]) return false;
    }
    return true;
  }

  function updateUndoRedoButtons(){
    var u = get("undoBtn");
    var r = get("redoBtn");
    if (u) u.disabled = !(historyIndex > 0);
    if (r) r.disabled = !(historyIndex >= 0 && historyIndex < history.length - 1);
  }

  function pushHistory(){
    var snap = snapshotState();
    if (historyIndex >= 0 && sameSnapshot(history[historyIndex], snap)) return;

    history = history.slice(0, historyIndex + 1);
    history.push(snap);

    if (history.length > HISTORY_MAX){
      history.shift();
    }
    historyIndex = history.length - 1;
    updateUndoRedoButtons();
  }

  function applySnapshot(snap){
    if (!snap) return;
    for (var i=0;i<ALL_BEDS.length;i++){
      var b = ALL_BEDS[i];
      bedStatus[b] = snap.bedStatus[b];
      bedObsGroup[b] = snap.bedObsGroup[b];
    }
    selectedRoom = snap.selectedRoom;
    renderRoomList();
    renderRoomEditor();
    updateChips();
    refreshCoverageControls();
    try{ if (saved && saved.lightPanelOpen) get("lightPanel").setAttribute("data-open","1"); }catch(e){}
    renderLightLoad();
    updateUndoRedoButtons();
    saveState();
    if (lastAssignments) renderObsSummary();
  }

  function undo(){
    if (historyIndex > 0){
      historyIndex--;
      applySnapshot(history[historyIndex]);
      updateUndoRedoButtons();
      toast("Undone");
    }
  }

  function redo(){
    if (historyIndex < history.length - 1){
      historyIndex++;
      applySnapshot(history[historyIndex]);
      updateUndoRedoButtons();
      toast("Redone");
    }
  }

  if (saved && typeof saved.randomizeTotals === "boolean") randomizeTotals = saved.randomizeTotals;

  for (var i=0;i<ALL_BEDS.length;i++){
    var b = ALL_BEDS[i];
    var st = saved && saved.bedStatus ? saved.bedStatus[b] : null;
    bedStatus[b] = (STATUS.indexOf(st) >= 0) ? st : "Occupied";

    var og = saved && saved.bedObsGroup ? saved.bedObsGroup[b] : null;
    bedObsGroup[b] = (OBS_GROUPS.indexOf(og) >= 0) ? og : "Unassigned";
  }

    if (saved && Array.isArray(saved.cnaCardOpen)) cnaCardOpen = saved.cnaCardOpen.slice();
var selectedRoom = ALL_ROOMS[0];
  if (saved && typeof saved.selectedRoom === "number" && ALL_ROOMS.indexOf(saved.selectedRoom) >= 0){
    selectedRoom = saved.selectedRoom;
  }

  
  if (saved && Array.isArray(saved.cnaAdjust)) cnaAdjust = saved.cnaAdjust.slice();
  if (saved && Array.isArray(saved.lightRules)) lightRules = saved.lightRules.slice();
function saveState(){
    try{
      var state = {
        bedStatus: bedStatus,
        bedObsGroup: bedObsGroup,
        cnaCount: (get("cnaCount") && get("cnaCount").value) ? get("cnaCount").value : "7",
        randomizeTotals: randomizeTotals,
        filterMode: (get("filterMode") && get("filterMode").value) ? get("filterMode").value : "all",
        printDate: (get("printDate") && get("printDate").value) ? get("printDate").value : "",
        printShift: (get("printShift") && get("printShift").value) ? get("printShift").value : "Day",
        onePerPage: !!(get("onePerPage") && get("onePerPage").checked),
        copyIncludeObs: !!(get("copyIncludeObs") && get("copyIncludeObs").checked),
        copyPageBreaks: !!(get("copyPageBreaks") && get("copyPageBreaks").checked),
        printRoomList: !!(get("printRoomList") && get("printRoomList").checked),
        printDetails: !!(get("printDetails") && get("printDetails").checked),
        detailsDefault: !!(get("detailsDefault") && get("detailsDefault").checked),
        selectedRoom: selectedRoom
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      setSaveStatus("Saved");
    }catch(e){
      setSaveStatus("No storage");
    }
  }

  function getBedsByStatus(statuses){
    var out = [];
    for (var i=0;i<ALL_BEDS.length;i++){
      var b = ALL_BEDS[i];
      if (statuses.indexOf(bedStatus[b]) >= 0) out.push(b);
    }
    return out;
  }

  function getCounts(){
    var occupied = getBedsByStatus(["Occupied"]);
    var obs = getBedsByStatus(["On Observation"]);
    var adm = getBedsByStatus(["Pending Admission"]);
    var hosp = getBedsByStatus(["Out to Hospital"]);
    var empty = getBedsByStatus(["Empty"]);
    var censusBeds = occupied.length + obs.length;
    var workloadBeds = occupied.length + adm.length;

    var roomSet = {};
    var active = getBedsByStatus(["Occupied","On Observation","Pending Admission"]);
    for (var i=0;i<active.length;i++) roomSet[roomNum(active[i])] = true;
    var roomCount = 0;
    for (var k in roomSet) roomCount++;

    return { occupied: occupied, obs: obs, adm: adm, hosp: hosp, empty: empty, censusBeds: censusBeds, workloadBeds: workloadBeds, rooms: roomCount };
  }

  function updateChips(){
    var c = getCounts();
    get("chipCensus").textContent = c.censusBeds;
    get("chipWorkload").textContent = c.workloadBeds;
    get("chipObs").textContent = c.obs.length;
    get("chipAdm").textContent = c.adm.length;
    get("chipRooms").textContent = c.rooms;
    if(get("chipOHP")) get("chipOHP").textContent = c.hosp.length;
    if(get("chipEMP")) get("chipEMP").textContent = c.empty.length;
    if(get("chipLicensed")) get("chipLicensed").textContent = LICENSED_BEDS;

    get("shuffleAgain").disabled = true;
    get("printBtn").disabled = true;
    get("loadStats").textContent = "-";

    get("copyAllBtn").disabled = true;
    get("copyObsBtn").disabled = true;
    get("copyHospBtn").disabled = true;
    get("copyAllWordBtn").disabled = true;
    if(get("toggleAllDetailsBtn")) get("toggleAllDetailsBtn").disabled = true;
    renderHospList();
  }

  function roomBadgesFor(r){
    var beds = bedsForRoom(r);
    var counts = { "Occupied":0, "On Observation":0, "Pending Admission":0, "Out to Hospital":0, "Empty":0 };
    for (var i=0;i<beds.length;i++){
      var st = bedStatus[beds[i]];
      if (counts[st] === undefined) counts[st] = 0;
      counts[st] += 1;
    }
    var out = [];
    if (counts["Occupied"]) out.push({cls:"occ", text:"OCC "+counts["Occupied"]});
    if (counts["On Observation"]) out.push({cls:"obs", text:"OBS "+counts["On Observation"]});
    if (counts["Pending Admission"]) out.push({cls:"adm", text:"ADM "+counts["Pending Admission"]});
    if (counts["Out to Hospital"]) out.push({cls:"hosp", text:"OHP "+counts["Out to Hospital"]});
    if (counts["Empty"]) out.push({cls:"empty", text:"EMP "+counts["Empty"]});
    if (out.length === 0) out.push({cls:"", text:"‚Äî"});
    return out;
  }

  function roomMatchesFilter(r, mode){
    var beds = bedsForRoom(r);
    var hasCensus = false, hasObs = false, hasAdm = false, hasEmpty = false, hasHosp = false;
    for (var i=0;i<beds.length;i++){
      var st = bedStatus[beds[i]];
      if (st === "Occupied" || st === "On Observation") hasCensus = true;
      if (st === "On Observation") hasObs = true;
      if (st === "Pending Admission") hasAdm = true;
      if (st === "Empty") hasEmpty = true;
      if (st === "Out to Hospital") hasHosp = true;
    }
    if (mode === "hasCensus") return hasCensus;
    if (mode === "hasObs") return hasObs;
    if (mode === "hasAdm") return hasAdm;
    if (mode === "hasEmpty") return hasEmpty;
    if (mode === "hasHosp") return hasHosp;
    return true;
  }

  function renderRoomList(){
    var mode = get("filterMode").value || "all";
    var list = get("roomList");
    list.innerHTML = "";

    var rooms = [];
    for (var i=0;i<ALL_ROOMS.length;i++){
      var r = ALL_ROOMS[i];
      if (roomMatchesFilter(r, mode)) rooms.push(r);
    }

    
    // If a saved filter results in zero rooms, fall back to showing all rooms (prevents "blank rooms" confusion).
    if (rooms.length === 0 && mode !== "all"){
      try { get("filterMode").value = "all"; } catch(e){}
      mode = "all";
      for (var k=0;k<ALL_ROOMS.length;k++){
        var rr = ALL_ROOMS[k];
        if (roomMatchesFilter(rr, mode)) rooms.push(rr);
      }
      saveState();
    }

    if (rooms.indexOf(selectedRoom) < 0 && rooms.length) selectedRoom = rooms[0];

    for (var i=0;i<rooms.length;i++){
      (function(r){
        var btn = document.createElement("button");
        btn.type = "button";
        btn.className = "roomBtn" + (r === selectedRoom ? " active" : "");

        var left = document.createElement("span");
        left.textContent = "Room " + r;

        var badges = document.createElement("span");
        badges.className = "roomBadges";

        var bs = roomBadgesFor(r);
        for (var j=0;j<bs.length;j++){
          var sp = document.createElement("span");
          sp.className = "badge " + (bs[j].cls || "");
          sp.textContent = bs[j].text;
          badges.appendChild(sp);
        }

        btn.appendChild(left);
        btn.appendChild(badges);

        btn.addEventListener("click", function(){
          selectedRoom = r;
          renderRoomList();
          renderRoomEditor();
          saveState();
        });

        list.appendChild(btn);
      })(rooms[i]);
    }

    if (rooms.length === 0){
      var empty = document.createElement("div");
      empty.style.padding = "10px";
      empty.style.color = "#64748b";
      empty.style.fontSize = "12px";
      empty.textContent = "(no rooms match filter)";
      list.appendChild(empty);
    }
  }

  function setRoomStatus(room, newStatus){
    var beds = bedsForRoom(room);
    for (var i=0;i<beds.length;i++){
      bedStatus[beds[i]] = newStatus;
      if (newStatus !== "On Observation") bedObsGroup[beds[i]] = "Unassigned";
    }
  }

  function statusClass(st){
    if (st === "Occupied") return "occ";
    if (st === "On Observation") return "obs";
    if (st === "Pending Admission") return "adm";
    if (st === "Out to Hospital") return "hosp";
    return "empty";
  }

  var lastAssignments = null;
  var lastWorkloadSnapshot = null;
  var lastLabels = null;
  var cnaCardOpen = [];
  var lastNote = "";

  // Coverage-change undo/redo history (separate from census undo/redo)
  var coverageHist = [];
  var coveragePtr = -1;
  function renderRoomEditor(){
    var title = get("roomEditorTitle");
    var body = get("roomEditorBody");
    var r = selectedRoom;

    title.textContent = "Room " + r + " ‚Äî Edit beds";

    var ids = ["roomOcc","roomEmpty","roomObs","roomAdm"];
    for (var i=0;i<ids.length;i++) get(ids[i]).disabled = false;

    body.innerHTML = "";

    var beds = bedsForRoom(r);

    var obsBeds = [];
    for (var i=0;i<beds.length;i++){
      if (bedStatus[beds[i]] === "On Observation") obsBeds.push(beds[i]);
    }

    var obsBlock = document.createElement("div");
    obsBlock.className = "bedRow";
    obsBlock.innerHTML =
      '<div class="bedLabel">Obs</div>' +
      '<div class="inlineRow">' +
        '<select id="roomObsGroupSel"></select>' +
        '<span class="helper" style="margin:0;">OBS: choose observer group (if needed)</span>' +
      '</div>';
    body.appendChild(obsBlock);

    var sel = obsBlock.querySelector("#roomObsGroupSel");
    for (var i=0;i<OBS_GROUPS.length;i++){
      var opt = document.createElement("option");
      opt.value = OBS_GROUPS[i];
      opt.textContent = OBS_GROUPS[i];
      sel.appendChild(opt);
    }

    if (obsBeds.length === 0){
      sel.value = "Unassigned";
      sel.disabled = true;
      obsBlock.classList.add("empty");
    } else {
      var first = bedObsGroup[obsBeds[0]] || "Unassigned";
      var allSame = true;
      for (var i=0;i<obsBeds.length;i++){
        if ((bedObsGroup[obsBeds[i]] || "Unassigned") !== first){ allSame = false; break; }
      }
      sel.value = allSame ? first : "Unassigned";
      sel.disabled = false;
      obsBlock.classList.add("obs");
    }

    sel.addEventListener("change", function(){
      pushHistory();
      var chosen = sel.value;
      for (var i=0;i<beds.length;i++){
        if (bedStatus[beds[i]] === "On Observation") bedObsGroup[beds[i]] = chosen;
      }
      updateChips();
      renderRoomList();
      saveState();
      if (lastAssignments) renderObsSummary();
    });

    for (var i=0;i<beds.length;i++){
      (function(b){
        var row = document.createElement("div");
        row.className = "bedRow " + statusClass(bedStatus[b]);
        row.setAttribute("data-bed", b);

        var label = document.createElement("div");
        label.className = "bedLabel";
        label.textContent = b;

        var right = document.createElement("div");
        right.className = "inlineRow";

        var stSel = document.createElement("select");
        for (var k=0;k<STATUS.length;k++){
          var o = document.createElement("option");
          o.value = STATUS[k];
          o.textContent = STATUS[k];
          stSel.appendChild(o);
        }
        stSel.value = bedStatus[b];

        stSel.addEventListener("change", function(){
          pushHistory();
          bedStatus[b] = stSel.value;
          if (bedStatus[b] !== "On Observation") bedObsGroup[b] = "Unassigned";
          renderRoomEditor();
          renderRoomList();
          updateChips();
          saveState();
          if (lastAssignments) renderObsSummary();
        });

        right.appendChild(stSel);
        row.appendChild(label);
        row.appendChild(right);
        body.appendChild(row);
      })(beds[i]);
    }
  }

  // Assignment logic (randomize who gets +1)
  function secureRandInt(maxExclusive){
    // Fallback if crypto not available
    if (window.crypto && window.crypto.getRandomValues){
      var arr = new Uint32Array(1);
      window.crypto.getRandomValues(arr);
      return arr[0] % maxExclusive;
    }
    return Math.floor(Math.random() * maxExclusive);
  }
  function shuffleInPlace(a){
    for (var i=a.length-1; i>0; i--){
      var j = secureRandInt(i+1);
      var tmp = a[i]; a[i] = a[j]; a[j] = tmp;
    }
    return a;
  }
  function buildFairSizes(total, cnaCount){
    var base = Math.floor(total / cnaCount);
    var rem  = total % cnaCount;
    var sizes = [];
    for (var i=0;i<cnaCount;i++) sizes.push(base + (i < rem ? 1 : 0));
    if (randomizeTotals) shuffleInPlace(sizes);
    return sizes;
  }
  function assignWorkloadBedsContinuous(workloadBedsOrdered, cnaCount){
    var cnAs = [];
    for (var i=0;i<cnaCount;i++) cnAs.push({patients:0, beds:[]});
    var total = workloadBedsOrdered.length;
    if (total === 0) return cnAs;

    var sizes = buildFairSizes(total, cnaCount);
    var idx = 0;
    for (var i=0;i<cnaCount;i++){
      var take = sizes[i];
      var slice = workloadBedsOrdered.slice(idx, idx + take);
      cnAs[i].beds = slice;
      cnAs[i].patients = slice.length;
      idx += take;
    }
    return cnAs;
  }

  function groupBedsByRoom(beds){
    var map = {};
    for (var i=0;i<beds.length;i++){
      var r = roomNum(beds[i]);
      if (!map[r]) map[r] = [];
      map[r].push(beds[i]);
    }
    var entries = [];
    for (var k in map){
      map[k].sort(function(a,b){ return a.slice(-1).localeCompare(b.slice(-1)); });
      entries.push([parseInt(k,10), map[k]]);
    }
    entries.sort(function(a,b){ return a[0]-b[0]; });
    return entries;
  }
  function bedRunLabel(beds){
    if (!beds || beds.length === 0) return "(no beds)";
    return beds[0] + " ‚Üí " + beds[beds.length - 1];
  }

  
  function buildRoomChecklistHTML(){
    // Room # checklist for paper handoffs
    var html = '<div class="printOnly roomChecklist">';
    html += '<div class="roomChecklistTitle">Room list</div>';
    html += '<div class="roomChecklistGrid">';
    for (var i=0;i<ALL_ROOMS.length;i++){
      var r = ALL_ROOMS[i];
      html += '<span class="rcItem"><span class="rcBox"></span><span class="rcNum">' + r + '</span></span>';
    }
    html += '</div></div>';
    return html;
  }

  function isPrintRoomListOn(){
    var el = get("printRoomList");
    return !!(el && el.checked);
  }

  function renderAssignments(assignments, labels, note){
    lastAssignments = assignments;
    lastLabels = labels;
    lastNote = note || "";
    lastLabels = Array.isArray(labels) ? labels.slice() : null;
    lastNote = note || "";
    var box = get("assignments");
    box.innerHTML = "";

    if (lastNote){
      var noteDiv = document.createElement("div");
      noteDiv.className = "box";
      noteDiv.style.borderStyle = "dashed";
      noteDiv.style.background = "rgba(37,99,235,.04)";
      noteDiv.innerHTML = '<div class="boxHead"><h3 style="margin:0;font-size:14px;">Coverage Change</h3><span class="tag">Auto-redistributed</span></div>' +
        '<div class="rows"><div class="line">' + escapeHtml(lastNote) + '</div></div>';
      box.appendChild(noteDiv);
    }

    for (var i=0;i<assignments.length;i++){
      (function(cna, idx){
        var div = document.createElement("div");
        div.className = "box cnaBox";
        var compact = (window.innerWidth || 0) < 760;
        div.classList.toggle("compact", compact);
        // Open/closed state is controlled by the user's per-card toggle (if any),
        // otherwise by the global default (Details default).
        var hasUser = (cnaCardOpen[idx] !== undefined && cnaCardOpen[idx] !== null);
        var defOpen = !!(get("detailsDefault") && get("detailsDefault").checked);
        var isOpen = hasUser ? !!cnaCardOpen[idx] : defOpen;
        div.classList.toggle("open", isOpen);

        var head = document.createElement("div");
        head.className = "boxHead";

        var h = document.createElement("h3");
        var labelNum = (Array.isArray(lastLabels) && lastLabels[idx] != null) ? lastLabels[idx] : (idx+1);
        h.textContent = "CNA " + labelNum;

        var headRight = document.createElement("div");
        headRight.style.display = "flex";
        headRight.style.gap = "8px";
        headRight.style.flexWrap = "wrap";
        headRight.style.alignItems = "center";

        var tag = document.createElement("span");
        tag.className = "tag";
        tag.textContent = cna.patients + " workload";

        var copyBtn = document.createElement("button");
        copyBtn.className = "tiny";
        copyBtn.textContent = "Copy";
        copyBtn.addEventListener("click", function(){ copySingleCna(idx); });

        headRight.appendChild(tag);
        headRight.appendChild(copyBtn);


        var toggleBtn = document.createElement("button");
        toggleBtn.className = "cnaToggle";
        toggleBtn.innerHTML = '<span class="car">‚ñæ</span><span class="txt">Details</span>';
        // Set initial label
        (function(){
          // Show the Details toggle on all screen sizes.
          var hasUser = (cnaCardOpen[idx] !== undefined && cnaCardOpen[idx] !== null);
          var defOpen = !!(get("detailsDefault") && get("detailsDefault").checked);
          // If the user has explicitly toggled this card before, respect that; otherwise use the default.
          var openNow = hasUser ? !!cnaCardOpen[idx] : defOpen;
          toggleBtn.querySelector('.car').textContent = openNow ? '‚ñ¥' : '‚ñæ';
          toggleBtn.querySelector('.txt').textContent = openNow ? 'Hide' : 'Details';
        })();

        toggleBtn.addEventListener("click", function(){
          // toggle open/closed in compact mode
          var isOpen = !!cnaCardOpen[idx];
          cnaCardOpen[idx] = !isOpen;
          saveState();
          renderAssignments(lastAssignments, lastLabels, lastNote);
        });
        headRight.appendChild(toggleBtn);

        head.appendChild(h);
        head.appendChild(headRight);

        var rows = document.createElement("div");
        rows.className = "rows";

        var summary = document.createElement("div");
        summary.className = "cnaSummary cnaRange";
        summary.textContent = "Room Range: " + bedRunLabel(cna.beds);
        rows.appendChild(summary);

        var details = document.createElement("div");
        details.className = "cnaDetails";

        var byRoom = groupBedsByRoom(cna.beds);
        for (var j=0;j<byRoom.length;j++){
          var room = byRoom[j][0];
          var beds = byRoom[j][1];
          var pretty = [];
          for (var k=0;k<beds.length;k++){
            pretty.push(beds[k] + (bedStatus[beds[k]] === "Pending Admission" ? " (ADM)" : ""));
          }
          var line = document.createElement("div");
          line.className = "line";
          line.innerHTML = "<b>Room " + room + "</b>: " + pretty.join(", ") + " <small>(" + beds.length + ")</small>";
          details.appendChild(line);
        }

        var hasAnyAdm = false;
        for (var j=0;j<cna.beds.length;j++){
          if (bedStatus[cna.beds[j]] === "Pending Admission"){ hasAnyAdm = true; break; }
        }
        if (hasAnyAdm){
          var note = document.createElement("div");
          note.className = "run";
          note.textContent = "";
          details.appendChild(note);
        }

        rows.appendChild(details);

        if (isPrintRoomListOn()){
          var rl = document.createElement("div");
          rl.innerHTML = buildRoomChecklistHTML();
          // buildRoomChecklistHTML returns a wrapper div; append its first child
          if (rl.firstChild) rows.appendChild(rl.firstChild);
        }

        div.appendChild(head);
        div.appendChild(rows);
        box.appendChild(div);
      })(assignments[i], i);
    }
    updateToggleAllDetailsButton();
  }

  function computeAllDetailsOpen(){
    if(!lastAssignments || !Array.isArray(lastAssignments)) return null;
    var defOpen = !!(get("detailsDefault") && get("detailsDefault").checked);
    for(var i=0;i<lastAssignments.length;i++){
      var hasUser = (cnaCardOpen[i] !== undefined && cnaCardOpen[i] !== null);
      var openNow = hasUser ? !!cnaCardOpen[i] : defOpen;
      if(!openNow) return false;
    }
    return true;
  }

  function updateToggleAllDetailsButton(){
    var btn = get("toggleAllDetailsBtn");
    if(!btn) return;
    if(!lastAssignments){ btn.style.display = "none"; return; }
    btn.style.display = "";
    var allOpen = computeAllDetailsOpen();
    btn.textContent = (allOpen === true) ? "Collapse all" : "Expand all";
  }

  function toggleAllDetails(){
    // Works on both mobile and desktop
    if(!lastAssignments) return;
    var allOpen = computeAllDetailsOpen();
    var target = (allOpen === true) ? false : true;
    cnaCardOpen = [];
    for(var i=0;i<lastAssignments.length;i++) cnaCardOpen[i] = target;
    saveState();
    renderAssignments(lastAssignments, lastLabels, lastNote);
  }

  function renderObsSummary(){
    var box = get("obsSummary");
    box.innerHTML = "";

    var obsBeds = getBedsByStatus(["On Observation"]);
    if (obsBeds.length === 0){
      box.innerHTML = '<div style="color:#64748b;font-size:12px">(no beds marked On Observation)</div>';
      return;
    }

    var groups = {};
    for (var i=0;i<obsBeds.length;i++){
      var b = obsBeds[i];
      var g = bedObsGroup[b] || "Unassigned";
      if (!groups[g]) groups[g] = [];
      groups[g].push(b);
    }

    var ordered = [];
    for (var i=0;i<OBS_GROUPS.length;i++){
      var gname = OBS_GROUPS[i];
      if (groups[gname] && gname !== "Unassigned") ordered.push(gname);
    }
    if (groups["Unassigned"]) ordered.push("Unassigned");

    for (var i=0;i<ordered.length;i++){
      var g = ordered[i];
      var beds = groups[g] || [];

      var div = document.createElement("div");
      div.className = "box";

      var head = document.createElement("div");
      head.className = "boxHead";
      var h = document.createElement("h3");
      h.textContent = g;
      var tag = document.createElement("span");
      tag.className = "tag";
      tag.textContent = beds.length + " on observation";
      head.appendChild(h);
      head.appendChild(tag);

      var rows = document.createElement("div");
      rows.className = "rows";

      var byRoom = groupBedsByRoom(beds);
      for (var j=0;j<byRoom.length;j++){
        var room = byRoom[j][0];
        var bedList = byRoom[j][1];
        var line = document.createElement("div");
        line.className = "line";
        line.innerHTML = "<b>Room " + room + "</b>: " + bedList.join(", ") + " <small>(" + bedList.length + ")</small>";
        rows.appendChild(line);
      }

      div.appendChild(head);
      div.appendChild(rows);
      box.appendChild(div);
    }
  }

  function renderHospList(){
    var host = get("hospList");
    if (!host) return;

    // Collect beds marked Out to Hospital
    var beds = [];
    for (var i=0;i<ALL_BEDS.length;i++){
      var b = ALL_BEDS[i];
      if (bedStatus[b] === "Out to Hospital") beds.push(b);
    }

    beds.sort(bedSort);

    // Display with commas (not pills) so it is always readable on mobile
    host.textContent = beds.length ? beds.join(", ") : "‚Äî";

    var btn = get("copyHospBtn");
    if (btn) btn.disabled = (beds.length === 0);

  }

  function copyHospOnly(){
    var c = getCounts();
    var beds = (c.hosp || []).slice();
    beds.sort(function(a,b){
      var ra = parseInt(a,10), rb = parseInt(b,10);
      if (ra !== rb) return ra - rb;
      return a.slice(-1).localeCompare(b.slice(-1));
    });
    var text = beds.length ? ("Out to Hospital:\n" + beds.join(", ")) : "Out to Hospital:\n(none)";
    copyText(text);
    toast("Hospital list copied");
  }

  function updatePrintHeaderMeta(){
    var d = get("printDate").value || "";
    var shift = get("printShift").value || "";
    var cn = get("cnaCount").value || "";
    var c = getCounts();

    var niceDate = d ? new Date(d + "T00:00:00").toLocaleDateString() : "‚Äî";
    get("phDate").textContent = niceDate;
    get("phShift").textContent = shift || "‚Äî";
    get("phCnas").textContent = cn || "‚Äî";
    get("phCensus").textContent = c.censusBeds;
    get("phWorkload").textContent = c.workloadBeds;
    get("phObs").textContent = c.obs.length;
    get("phAdm").textContent = c.adm.length;
    get("phGenerated").textContent = new Date().toLocaleString();
  }

  function setDefaultDateIfEmpty(){
    var d = get("printDate");
    if (!d.value){
      var now = new Date();
      var y = now.getFullYear();
      var m = String(now.getMonth()+1).padStart(2,"0");
      var da = String(now.getDate()).padStart(2,"0");
      d.value = y + "-" + m + "-" + da;
    }
  }

  function syncOnePerPage(){
    var on = !!get("onePerPage").checked;
    document.body.classList.toggle("print-one-per", on);
  }

  function formatHeaderText(){
    var d = get("printDate").value || "";
    var shift = get("printShift").value || "";
    var cn = get("cnaCount").value || "";
    var c = getCounts();
    var niceDate = d ? new Date(d + "T00:00:00").toLocaleDateString() : "‚Äî";
    return [
      "Catered Cottage Healthcare ‚Äî CNA Assignments",
      "Date: " + niceDate + " | Shift: " + shift + " | CNAs: " + cn,
      "Census: " + c.censusBeds + " | CNA Workload: " + c.workloadBeds + " | On Observation: " + c.obs.length + " | Pending Admission: " + c.adm.length,
      "Generated: " + new Date().toLocaleString()
      ].concat(lastNote ? ["Note: " + lastNote] : []).join("\n");
  }

  function formatCnaText(idx){
    if (!lastAssignments) return "";
    var cna = lastAssignments[idx];
    var lines = [];
    var labelNum = (Array.isArray(lastLabels) && lastLabels[idx] != null) ? lastLabels[idx] : (idx+1);
    lines.push("CNA " + labelNum + " ‚Äî Workload: " + cna.patients);
    lines.push("Range: " + bedRunLabel(cna.beds));
    var byRoom = groupBedsByRoom(cna.beds);
    for (var i=0;i<byRoom.length;i++){
      var room = byRoom[i][0];
      var beds = byRoom[i][1];
      var pretty = [];
      for (var k=0;k<beds.length;k++){
        pretty.push(beds[k] + (bedStatus[beds[k]] === "Pending Admission" ? " (ADM)" : ""));
      }
      lines.push("Room " + room + ": " + pretty.join(", "));
    }
    lines.push("");
    return lines.join("\n");
  }

  function formatObsText(){
    var obsBeds = getBedsByStatus(["On Observation"]);
    if (obsBeds.length === 0) return "Observation List (On Observation): (none)";
    var groups = {};
    for (var i=0;i<obsBeds.length;i++){
      var b = obsBeds[i];
      var g = bedObsGroup[b] || "Unassigned";
      if (!groups[g]) groups[g] = [];
      groups[g].push(b);
    }
    var ordered = [];
    for (var i=0;i<OBS_GROUPS.length;i++){
      var gname = OBS_GROUPS[i];
      if (groups[gname] && gname !== "Unassigned") ordered.push(gname);
    }
    if (groups["Unassigned"]) ordered.push("Unassigned");

    var out = [];
    out.push("Observation List (On Observation)");
    for (var i=0;i<ordered.length;i++){
      var g = ordered[i];
      var beds = groups[g] || [];
      beds.sort(function(a,b){
        var ra = parseInt(a,10), rb = parseInt(b,10);
        if (ra !== rb) return ra - rb;
        return a.slice(-1).localeCompare(b.slice(-1));
      });
      out.push(g + ": " + beds.join(", "));
    }
    return out.join("\n");
  }

  function copyText(text){
    // Try modern clipboard API (secure contexts)
    if (navigator.clipboard && window.isSecureContext){
      navigator.clipboard.writeText(text).then(function(){
        toast("Copied");
      }).catch(function(){
        fallbackCopy(text);
      });
      return;
    }
    fallbackCopy(text);
  }

  function fallbackCopy(text){
    try{
      var ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      ta.style.top = "0";
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      var ok = document.execCommand("copy");
      document.body.removeChild(ta);
      if (ok){ toast("Copied"); return; }
    }catch(e){}
    openCopyModal(text);
    toast("Clipboard blocked");
  }

  function copySingleCna(idx){ copyText(formatHeaderText() + "\n\n" + formatCnaText(idx)); }
  function copyAll(){
    var parts = [formatHeaderText(), ""];
    for (var i=0;i<lastAssignments.length;i++){ parts.push(formatCnaText(i), ""); }
    if (get("copyIncludeObs").checked){ parts.push(formatObsText(), ""); }
    copyText(parts.join("\n"));
  }
  function copyAllForWord(){
    var addBreaks = get("copyPageBreaks").checked;
    var pageBreak = "\n\n‚Äî‚Äî‚Äî PAGE BREAK ‚Äî‚Äî-\n\n";
    var parts = [formatHeaderText(), ""];
    for (var i=0;i<lastAssignments.length;i++){
      parts.push(formatCnaText(i));
      if (i !== lastAssignments.length - 1) parts.push(addBreaks ? pageBreak : "\n");
      else parts.push("\n");
    }
    if (get("copyIncludeObs").checked){ parts.push(formatObsText(), ""); }
    copyText(parts.join("\n"));
  }
  function copyObsOnly(){ copyText(formatHeaderText() + "\n\n" + formatObsText()); }

  function jumpToRoom(q){
    q = String(q || "").trim().toUpperCase();
    if (!q) return;
    var m = q.match(/^(\d{1,2})([ABC])?$/);
    if (!m) return;
    var room = parseInt(m[1],10);
    if (ALL_ROOMS.indexOf(room) < 0) return;

    selectedRoom = room;
    renderRoomList();
    renderRoomEditor();
    saveState();

    // Auto-scroll: make sure the selected room and editor are visible (especially when lists are long).
    setTimeout(function(){
      try{
        var list = get("roomList");
        if (list){
          var active = list.querySelector(".roomBtn.active");
          if (active && active.scrollIntoView) active.scrollIntoView({ block: "center" });
        }
        var title = get("roomEditorTitle");
        if (title && title.scrollIntoView) title.scrollIntoView({ block: "start" });

        // If user typed a specific bed letter (e.g., 20A), scroll to that bed row too.
        var letter = m[2] || "";
        if (letter){
          var bed = String(room) + letter;
          var row = document.querySelector('[data-bed="' + bed + '"]');
          if (row && row.scrollIntoView) row.scrollIntoView({ block: "center" });
        }
      }catch(e){}
    }, 0);
  }

  function roomOrderingBeds(){
    var beds = getBedsByStatus(["Occupied","Pending Admission"]);
    beds.sort(function(a,b){
      var ra = parseInt(a,10), rb = parseInt(b,10);
      if (ra !== rb) return ra - rb;
      return a.slice(-1).localeCompare(b.slice(-1));
    });
    return beds;
  }

  function doGenerate(reuseSnapshot){
    var cnaCount = parseInt(get("cnaCount").value || "7", 10);
    if (isNaN(cnaCount)) cnaCount = 7;
    cnaCount = Math.max(1, Math.min(30, cnaCount));
    get("cnaCount").value = cnaCount;

    var workloadBeds = (reuseSnapshot && lastWorkloadSnapshot) ? lastWorkloadSnapshot.slice() : roomOrderingBeds();

    ensureCnaAdjust();
    var targets = computeTargetsWithAdjust(workloadBeds.length, cnaCount, cnaAdjust);
    var spread = !!(get("spreadRooms") && get("spreadRooms").checked);
    var assignments = spread ? assignWorkloadBedsGreedy(workloadBeds, targets) : assignWorkloadBedsByTargets(workloadBeds, targets);
    renderAssignments(assignments, null, "");
    renderObsSummary();

    var loads = [];
    for (var i=0;i<assignments.length;i++) loads.push(assignments[i].patients);
    var min = loads.length ? Math.min.apply(null, loads) : 0;
    var max = loads.length ? Math.max.apply(null, loads) : 0;
    get("loadStats").textContent = min + "/" + max + "/" + (max-min);

    lastAssignments = assignments;
    lastWorkloadSnapshot = workloadBeds;

    // Reset coverage-change history whenever we generate/shuffle
    initCoverageHistory();

    get("shuffleAgain").disabled = false;
    get("printBtn").disabled = false;
    get("copyAllBtn").disabled = false;
    get("copyObsBtn").disabled = false;
    get("copyAllWordBtn").disabled = false;
    if(get("toggleAllDetailsBtn")) get("toggleAllDetailsBtn").disabled = false;

    refreshCoverageControls();
    updatePrintHeaderMeta();
    renderLightLoad();
    saveState();
  }


  function ensureCnaNames(){
    var n = parseInt(get("cnaCount").value || "1", 10);
    if (!Array.isArray(cnaNames)) cnaNames = [];
    while (cnaNames.length < n) cnaNames.push("");
    if (cnaNames.length > n) cnaNames = cnaNames.slice(0, n);
  }

  
  function ensureCnaAdjust(){
    var n = parseInt(get("cnaCount").value || "1", 10);
    if (!Array.isArray(cnaAdjust)) cnaAdjust = [];
    while (cnaAdjust.length < n) cnaAdjust.push(0);
    if (cnaAdjust.length > n) cnaAdjust = cnaAdjust.slice(0, n);
  }

  function ensureLightRules(){
    if (!Array.isArray(lightRules)) lightRules = [];
    // Migrate: if no rules saved but cnaAdjust has reductions, build rules from it once.
    if (lightRules.length === 0 && Array.isArray(cnaAdjust)){
      for (var i=0;i<cnaAdjust.length;i++){
        if (cnaAdjust[i] < 0){
          lightRules.push({ cna: i+1, adj: cnaAdjust[i] });
        }
      }
    }
  }

  function rulesToAdjust(){
    ensureCnaAdjust();
    // reset
    for (var i=0;i<cnaAdjust.length;i++) cnaAdjust[i] = 0;

    ensureLightRules();
    for (var r=0;r<lightRules.length;r++){
      var c = parseInt(lightRules[r].cna || "", 10);
      var a = parseInt(lightRules[r].adj || "0", 10) || 0;
      if (isNaN(c) || c < 1 || c > cnaAdjust.length) continue;
      if (a !== -1 && a !== -2) continue;
      cnaAdjust[c-1] = a; // last rule wins
    }
  }

  function setLightPill(){
    var pill = get("lightPill");
    if (!pill) return;
    ensureLightRules();
    var on = lightRules.length > 0;
    pill.textContent = on ? ("ON (" + lightRules.length + ")") : "OFF";
    pill.className = "lpPill" + (on ? " on" : "");
  }

  function renderLightLoad(){
    var panel = get("lightPanel");
    var body = get("lightBody");
    var rows = get("lightRules");
    var toggle = get("lightToggle");
    var caret = get("lightCaret");
    if (!panel || !rows || !toggle || !body) return;

    ensureCnaAdjust();
    ensureLightRules();
    rulesToAdjust();
    setLightPill();

    // keep expanded state in memory (localStorage via saveState already)
    var expanded = panel.getAttribute("data-open") === "1";
    body.hidden = !expanded;
    if (caret) caret.textContent = expanded ? "‚ñ¥" : "‚ñæ";
    toggle.setAttribute("aria-expanded", expanded ? "true" : "false");

    rows.innerHTML = "";

    if (lightRules.length === 0){
      var hint = document.createElement("div");
      hint.style.fontSize = "12px";
      hint.style.color = "var(--muted)";
      hint.textContent = "No light-load CNAs selected. Click ‚Äú+ Add CNA‚Äù.";
      rows.appendChild(hint);
      return;
    }

    for (var i=0;i<lightRules.length;i++){
      (function(idx){
        var rule = lightRules[idx];

        var wrap = document.createElement("div");
        wrap.className = "lightRule";

        var left = document.createElement("div");
        left.className = "left";

        var tag = document.createElement("div");
        tag.className = "tag";
        tag.textContent = "CNA " + (rule.cna || "?");

        var cnaSel = document.createElement("select");
        // CNA options
        var n = parseInt(get("cnaCount").value || "1", 10);
        for (var k=1;k<=n;k++){
          var op = document.createElement("option");
          op.value = String(k);
          op.textContent = "CNA " + k;
          cnaSel.appendChild(op);
        }
        cnaSel.value = String(rule.cna || 1);

        var adjSel = document.createElement("select");
        adjSel.innerHTML = ""
          + "<option value='-1'>-1 patient</option>"
          + "<option value='-2'>-2 patients</option>";
        adjSel.value = String(rule.adj || -1);

        var rm = document.createElement("button");
        rm.type = "button";
        rm.className = "remove";
        rm.textContent = "Remove";

        cnaSel.addEventListener("change", function(){
          rule.cna = parseInt(cnaSel.value || "1", 10) || 1;
          saveState();
          renderLightLoad();
        });
        adjSel.addEventListener("change", function(){
          rule.adj = parseInt(adjSel.value || "-1", 10) || -1;
          saveState();
          setLightPill();
        });
        rm.addEventListener("click", function(){
          lightRules.splice(idx, 1);
          saveState();
          renderLightLoad();
        });

        left.appendChild(tag);
        left.appendChild(cnaSel);
        left.appendChild(adjSel);

        wrap.appendChild(left);
        wrap.appendChild(rm);

        rows.appendChild(wrap);
      })(i);
    }
  }


  

  function shuffledIndices(n){
    var arr = [];
    for (var i=0;i<n;i++) arr.push(i);
    // Fisher‚ÄìYates shuffle
    for (var j=n-1;j>0;j--){
      var k = Math.floor(Math.random()*(j+1));
      var tmp = arr[j]; arr[j] = arr[k]; arr[k] = tmp;
    }
    return arr;
  }


  function computeTargetsWithAdjust(totalBeds, cnaCount, adjustments){
    var base = Math.floor(totalBeds / cnaCount);
    var rem = totalBeds % cnaCount;

    // Start all at base
    var targets = [];
    for (var i=0;i<cnaCount;i++) targets.push(base);

    // Distribute remainder (+1) either in order or randomly (fair)
    var order = [];
    if (randomizeTotals){
      order = shuffledIndices(cnaCount);
    } else {
      for (var i=0;i<cnaCount;i++) order.push(i);
    }
    for (var r=0;r<rem;r++){
      targets[order[r]] += 1;
    }

    // Apply reductions (0, -1, -2...)
    var adj = [];
    for (var i=0;i<cnaCount;i++){
      adj[i] = (adjustments && typeof adjustments[i] === "number") ? adjustments[i] : 0;
      if (adj[i] < 0){
        targets[i] = Math.max(0, targets[i] + adj[i]);
      }
    }

    // Fill deficit by adding to other CNAs fairly (prefer non-reduced).
    // If randomizeTotals is ON, we also randomize tie-breaking so the same CNA doesn't always get the extra.
    var sum = 0;
    for (var i=0;i<cnaCount;i++) sum += targets[i];
    var deficit = totalBeds - sum;

    var eligible = [];
    for (var i=0;i<cnaCount;i++){ if (adj[i] >= 0) eligible.push(i); }
    if (!eligible.length){ for (var i=0;i<cnaCount;i++) eligible.push(i); }

    while (deficit > 0){
      var best = null;
      var bestSet = [];
      for (var k=0;k<eligible.length;k++){
        var ii = eligible[k];
        var v = targets[ii];
        if (best === null || v < best){
          best = v;
          bestSet = [ii];
        } else if (v === best){
          bestSet.push(ii);
        }
      }
      var pick = bestSet[0];
      if (bestSet.length > 1 && randomizeTotals){
        pick = bestSet[Math.floor(Math.random()*bestSet.length)];
      }
      targets[pick] += 1;
      deficit -= 1;
    }

    return targets;
  }

  function assignWorkloadBedsByTargets(beds, targets){
    // Assign contiguous-ish blocks while honoring per-CNA targets.
    // NOTE: We keep CNA order (CNA 1 gets the first/lower rooms, then CNA 2, etc.)
    // Random totals (fair) randomizes WHO gets the +1 counts, not the room-block order.
    var n = targets.length;

    var out = [];
    for (var i=0;i<n;i++) out.push({ patients: 0, beds: [] });

    var cur = 0;
    for (var b=0;b<beds.length;b++){
      var guard = 0;
      while (cur < out.length && out[cur].beds.length >= targets[cur] && guard < out.length+2){
        cur += 1; guard += 1;
      }
      if (cur >= out.length) cur = out.length - 1;
      out[cur].beds.push(beds[b]);
    }

    for (var i=0;i<out.length;i++){
      out[i].beds.sort(bedSort);
      out[i].patients = out[i].beds.length;
    }
    return out;
  }



  function assignWorkloadBedsGreedy(beds, targets){
    // Spread rooms while honoring per-CNA targets: assign next bed to the currently-lightest eligible CNA.
    var n = targets.length;
    var out = [];
    for (var i=0;i<n;i++) out.push({ patients: 0, beds: [] });

    for (var b=0;b<beds.length;b++){
      var bestIdx = 0;
      var bestLoad = null;

      for (var i=0;i<n;i++){
        if (out[i].beds.length >= targets[i]) continue; // cannot exceed target
        var load = out[i].beds.length;
        if (bestLoad === null || load < bestLoad){
          bestLoad = load;
          bestIdx = i;
        }
      }

      // If all are full (shouldn't happen), place into last CNA
      if (bestLoad === null) bestIdx = n - 1;

      out[bestIdx].beds.push(beds[b]);
    }

    for (var i=0;i<out.length;i++){
      out[i].beds.sort(bedSort);
      out[i].patients = out[i].beds.length;
    }
    return out;
  }

  function computeFinalTargetsFromCurrent(currentLoads, addCount, adjustments){
    // desired total = sum(currentLoads) + addCount
    var n = currentLoads.length;
    var total = 0;
    for (var i=0;i<n;i++) total += (currentLoads[i] || 0);
    total += addCount;

    var baseTargets = computeTargetsWithAdjust(total, n, adjustments);

    // Never set target below current load
    for (var i=0;i<n;i++){
      baseTargets[i] = Math.max(currentLoads[i] || 0, baseTargets[i]);
    }

    // If clamped created deficit, add back to non-reduced
    var sum = 0;
    for (var i=0;i<n;i++) sum += baseTargets[i];
    var deficit = total - sum;
    if (deficit > 0){
      var eligible = [];
      for (var i=0;i<n;i++){
        var a = (adjustments && typeof adjustments[i] === "number") ? adjustments[i] : 0;
        if (a >= 0) eligible.push(i);
      }
      if (!eligible.length){ for (var i=0;i<n;i++) eligible.push(i); }
      while (deficit > 0){
        var best = null, bestIdx = eligible[0];
        for (var k=0;k<eligible.length;k++){
          var ii = eligible[k];
          var v = baseTargets[ii];
          if (best === null || v < best){ best = v; bestIdx = ii; }
        }
        baseTargets[bestIdx] += 1;
        deficit -= 1;
      }
    }

    return baseTargets;
  }


  function renderCnaNames(){
    var grid = get("cnaNamesGrid");
    if (!grid) return;
    ensureCnaNames();
    grid.innerHTML = "";
    for (var i=0;i<cnaNames.length;i++){
      var wrap = document.createElement("div");
      var lbl = document.createElement("div");
      lbl.style.fontSize = "12px";
      lbl.style.color = "var(--muted)";
      lbl.style.marginBottom = "6px";
      lbl.textContent = "CNA " + (i+1);
      var inp = document.createElement("input");
      inp.className = "nameInput";
      inp.type = "text";
      inp.placeholder = "Name (optional)";
      inp.value = cnaNames[i] || "";
      (function(idx){
        inp.addEventListener("input", function(){
          cnaNames[idx] = inp.value.trim();
          saveState();
        });
      })(i);
      wrap.appendChild(lbl);
      wrap.appendChild(inp);
      grid.appendChild(wrap);
    }
  }

  // Wire events
  if(get("clearNamesBtn")) get("clearNamesBtn").addEventListener("click", function(){ ensureCnaNames(); for(var i=0;i<cnaNames.length;i++) cnaNames[i]=""; renderCnaNames(); saveState(); toast("Names cleared"); });

  // Tap top chips to auto-filter the room list
  function setRoomFilter(mode){
    var sel = get("filterMode");
    if (!sel) return;
    sel.value = mode;
    saveState();
    renderRoomList();
    toast("Filter: " + sel.options[sel.selectedIndex].text);
    // gently scroll to the filter control on mobile
    try{ sel.scrollIntoView({behavior:"smooth", block:"center"}); }catch(e){}
  }

  var empWrap = get("chipEmpWrap");
  var ohpWrap = get("chipOHPWrap");
  var obsWrap = get("chipOBSWrap");
  var admWrap = get("chipADMWrap");
  if (empWrap) empWrap.addEventListener("click", function(){ setRoomFilter("hasEmpty"); });
  if (ohpWrap) ohpWrap.addEventListener("click", function(){ setRoomFilter("hasHosp"); });
  if (obsWrap) obsWrap.addEventListener("click", function(){ setRoomFilter("hasObs"); });
  if (admWrap) admWrap.addEventListener("click", function(){ setRoomFilter("hasAdm"); });

  get("undoBtn").addEventListener("click", undo);
  get("redoBtn").addEventListener("click", redo);

  document.addEventListener("keydown", function(e){
    var z = (e.key === "z" || e.key === "Z");
    var y = (e.key === "y" || e.key === "Y");
    if ((e.ctrlKey || e.metaKey) && z){
      e.preventDefault();
      undo();
    } else if ((e.ctrlKey || e.metaKey) && y){
      e.preventDefault();
      redo();
    }
  });

  get("toggleRandom").addEventListener("click", function(){
    randomizeTotals = !randomizeTotals;
    get("randState").textContent = randomizeTotals ? "ON" : "OFF";
    saveState();
  });
  get("searchBox").addEventListener("keydown", function(e){
    if (e.key === "Enter") jumpToRoom(e.target.value);
  });

  
  function refreshCoverageControls(){
    var sel = get("absentCna");
    var btn = get("applyCoverage");
    if (!sel || !btn) return;

    var n = parseInt(get("cnaCount").value || "0", 10);
    if (isNaN(n) || n < 1) n = 1;

    // Build options
    var cur = sel.value;
    sel.innerHTML = '<option value="">Select CNA‚Ä¶</option>';
    for (var i=0;i<n;i++){
      var num = i+1;
      var opt = document.createElement("option");
      opt.value = String(num);
      var name = (Array.isArray(cnaNames) && cnaNames[i]) ? (" ‚Äî " + cnaNames[i]) : "";
      opt.textContent = "CNA " + num + name;
      sel.appendChild(opt);
    }
    if (cur) sel.value = cur;

    btn.disabled = !lastAssignments;

    // Keep coverage undo/redo buttons in sync
    updateCoverageHistoryUI();
  }

  function recalcLoadStats(assignments){
    var loads = [];
    for (var i=0;i<assignments.length;i++) loads.push(assignments[i].patients);
    var min = loads.length ? Math.min.apply(null, loads) : 0;
    var max = loads.length ? Math.max.apply(null, loads) : 0;
    get("loadStats").textContent = min + "/" + max + "/" + (max-min);
  }

  function cloneAssignments(as){
    var out = [];
    for (var i=0;i<as.length;i++){
      out.push({ patients: as[i].patients, beds: (as[i].beds || []).slice() });
    }
    return out;
  }


  function snapshotCoverageState(noteOverride){
    return {
      assignments: lastAssignments ? cloneAssignments(lastAssignments) : null,
      labels: Array.isArray(lastLabels) ? lastLabels.slice() : null,
      note: (typeof noteOverride === "string") ? noteOverride : (lastNote || "")
    };
  }

  function initCoverageHistory(){
    // Start history from the current generated assignments
    if (!lastAssignments){ coverageHist = []; coveragePtr = -1; updateCoverageHistoryUI(); return; }
    coverageHist = [ snapshotCoverageState() ];
    coveragePtr = 0;
    updateCoverageHistoryUI();
  }

  function pushCoverageHistory(nextNote){
    if (!lastAssignments) return;
    var snap = snapshotCoverageState(nextNote);
    // Trim any redo states
    if (coveragePtr < coverageHist.length - 1){
      coverageHist = coverageHist.slice(0, coveragePtr + 1);
    }
    coverageHist.push(snap);
    coveragePtr = coverageHist.length - 1;
    updateCoverageHistoryUI();
  }

  function restoreCoverageAt(ptr){
    if (ptr < 0 || ptr >= coverageHist.length) return;
    var snap = coverageHist[ptr];
    if (!snap || !snap.assignments) return;
    lastAssignments = cloneAssignments(snap.assignments);
    lastLabels = Array.isArray(snap.labels) ? snap.labels.slice() : null;
    lastNote = snap.note || "";
    renderAssignments(lastAssignments, lastLabels, lastNote);
    recalcLoadStats(lastAssignments);
    renderObsSummary();
    refreshCoverageControls();
    // keep copy/print enabled
    get("printBtn").disabled = false;
    get("copyAllBtn").disabled = false;
    get("copyObsBtn").disabled = false;
    get("copyAllWordBtn").disabled = false;
    if(get("toggleAllDetailsBtn")) get("toggleAllDetailsBtn").disabled = false;
    updateCoverageHistoryUI();
  }

  function updateCoverageHistoryUI(){
    var u = get("coverageUndo");
    var r = get("coverageRedo");
    var c = get("coverageClear");
    if (!u || !r || !c) return;
    var has = (coverageHist && coverageHist.length && coveragePtr >= 0);
    u.disabled = !(has && coveragePtr > 0);
    r.disabled = !(has && coveragePtr < coverageHist.length - 1);
    c.disabled = !(has && coveragePtr > 0); // only meaningful if changed from baseline
  }

  

  function bedRoomNum(bed){
    bed = String(bed || "");
    var m = bed.match(/^(\d+)/);
    return m ? parseInt(m[1],10) : 0;
  }
  function computeCenters(assignments){
    var centers = [];
    for (var i=0;i<assignments.length;i++){
      var beds = assignments[i].beds || [];
      if (!beds.length){ centers.push(0); continue; }
      var nums = [];
      for (var j=0;j<beds.length;j++) nums.push(bedRoomNum(beds[j]));
      nums.sort(function(a,b){return a-b;});
      var mid = Math.floor(nums.length/2);
      centers.push(nums.length % 2 ? nums[mid] : Math.round((nums[mid-1]+nums[mid])/2));
    }
    return centers;
  }



  function computeTargetLoads(kept, addCount){
    // Produces a balanced final workload target by distributing additional beds
    // one-by-one to the current lowest workload CNA (difference ends <= 1).
    var targets = [];
    for (var i=0;i<kept.length;i++) targets.push(kept[i].patients || 0);
    for (var k=0;k<addCount;k++){
      var best = null;
      var bestIdx = 0;
      for (var j=0;j<targets.length;j++){
        var v = targets[j];
        if (best === null || v < best){ best = v; bestIdx = j; }
      }
      targets[bestIdx] += 1;
    }
    return targets;
  }

function redistributeAfterCnaLeaves(absentIdx, mode, keepClose, fairnessMode){
    if (!lastAssignments || absentIdx < 0 || absentIdx >= lastAssignments.length) return null;
    var originalN = lastAssignments.length;
    if (originalN <= 1) return null;

    // Beds to redistribute
    var give = (lastAssignments[absentIdx].beds || []).slice();
    give.sort(bedSort);

    // Labels: keep original CNA numbers, excluding absent
    var labels = [];
    for (var i=0;i<originalN;i++){ if (i !== absentIdx) labels.push(i+1); }

    // Full reshuffle uses existing workload snapshot (keeps same bed pool)
    if (mode === "reshuffle"){
      var pool = (lastWorkloadSnapshot && lastWorkloadSnapshot.slice) ? lastWorkloadSnapshot.slice() : roomOrderingBeds();
      ensureCnaAdjust();
      var adj2 = [];
      for (var ai=0; ai<labels.length; ai++){
        var origIdx = labels[ai] - 1;
        adj2.push((typeof cnaAdjust[origIdx] === "number") ? cnaAdjust[origIdx] : 0);
      }
      var targets2 = computeTargetsWithAdjust(pool.length, originalN - 1, adj2);
      var newAs = assignWorkloadBedsByTargets(pool, targets2);
      return { assignments: newAs, labels: labels, note: "CNA " + (absentIdx+1) + " left early ‚Äî reshuffled assignments for remaining staff." };
    }

    // Minimal-change modes: keep everyone else, just spread the absent CNA's beds.
    var kept = [];
    for (var i=0;i<originalN;i++){
      if (i === absentIdx) continue;
      kept.push({ patients: lastAssignments[i].patients, beds: (lastAssignments[i].beds || []).slice() });
    }

    // Starting pointer: next CNA after absent, but within the kept list
    var startLabel = (absentIdx + 1) + 1; // human number for next CNA
    var startPos = 0;
    var centers = null;
    var currentLoads = [];
    for (var cl=0; cl<kept.length; cl++) currentLoads.push(kept[cl].patients || 0);
    ensureCnaAdjust();
    var adjKept = [];
    for (var ax=0; ax<labels.length; ax++){
      var orig = labels[ax] - 1;
      adjKept.push((typeof cnaAdjust[orig] === "number") ? cnaAdjust[orig] : 0);
    }
    var targetLoads = computeFinalTargetsFromCurrent(currentLoads, give.length, adjKept);
    for (var k=0;k<labels.length;k++){
      if (labels[k] === startLabel){ startPos = k; break; }
    }

    for (var b=0;b<give.length;b++){
      var bed = give[b];

      // Keep-close + fairness: prefer nearest rooms, but prevent one CNA from absorbing most of the load.
      // We apply a soft cap based on the expected balanced workload.
      // Fair + Close reassign:
      // 1) We compute balanced FINAL target loads first.
      // 2) While redistributing, we assign each bed to an eligible CNA:
      //    - Strict: cannot exceed target
      //    - Soft: may exceed target by +1 only if no one under target is close enough
      // 3) Among eligible CNAs, prefer nearest rooms; then apply chosen fairness mode.
      var targetIdx = 0;

      if (keepClose && !centers) centers = computeCenters(kept);

      // Determine eligibility
      var allowExtra = (fairnessMode === "soft") ? 1 : 0;

      // First pass: CNAs still under target
      var eligible = [];
      for (var ei=0; ei<kept.length; ei++){
        if ((kept[ei].patients || 0) < targetLoads[ei]) eligible.push(ei);
      }

      // Soft pass: if nobody is under target (should be rare), allow +1
      if (!eligible.length && allowExtra){
        for (var ej=0; ej<kept.length; ej++){
          if ((kept[ej].patients || 0) < (targetLoads[ej] + 1)) eligible.push(ej);
        }
      }

      // Absolute fallback: everyone (should never happen)
      if (!eligible.length){
        for (var ek=0; ek<kept.length; ek++) eligible.push(ek);
      }

      function pickByRotation(candidates){
        for (var step=0; step<kept.length; step++){
          var j = (startPos + step) % kept.length;
          if (candidates.indexOf(j) !== -1){
            targetIdx = j;
            startPos = (j+1) % kept.length;
            return;
          }
        }
        targetIdx = candidates[0] || 0;
        startPos = (targetIdx + 1) % kept.length;
      }

      // Prefer nearest room among eligible
      if (keepClose){
        var rnum = bedRoomNum(bed);
        var bestDist = null;
        for (var ed=0; ed<eligible.length; ed++){
          var ii = eligible[ed];
          var c = centers[ii] || 0;
          var d = Math.abs(rnum - c);
          if (bestDist === null || d < bestDist) bestDist = d;
        }
        var near = [];
        for (var ed2=0; ed2<eligible.length; ed2++){
          var ii2 = eligible[ed2];
          var c2 = centers[ii2] || 0;
          var d2 = Math.abs(rnum - c2);
          if (d2 === bestDist) near.push(ii2);
        }

        if (mode === "least"){
          // among nearest, pick lowest current workload; tie by rotation
          var bestLoad = null;
          for (var nl=0; nl<near.length; nl++){
            var idxN = near[nl];
            var load = kept[idxN].patients || 0;
            if (bestLoad === null || load < bestLoad) bestLoad = load;
          }
          var bestSet = [];
          for (var nl2=0; nl2<near.length; nl2++){
            var idxN2 = near[nl2];
            if ((kept[idxN2].patients || 0) === bestLoad) bestSet.push(idxN2);
          }
          pickByRotation(bestSet);
        } else {
          // order: rotation among nearest
          pickByRotation(near);
        }
      } else {
        // No keepClose: standard fairness
        if (mode === "least"){
          var best = null;
          for (var t=0;t<eligible.length;t++){
            var candIdx = eligible[t];
            var cand = kept[candIdx].patients || 0;
            if (best === null || cand < best) best = cand;
          }
          var bestSet2 = [];
          for (var t2=0;t2<eligible.length;t2++){
            var candIdx2 = eligible[t2];
            if ((kept[candIdx2].patients || 0) === best) bestSet2.push(candIdx2);
          }
          pickByRotation(bestSet2);
        } else {
          pickByRotation(eligible);
        }
      }
kept[targetIdx].beds.push(bed);
      kept[targetIdx].beds.sort(bedSort);
      kept[targetIdx].patients = kept[targetIdx].beds.length;
      if (keepClose && centers){ centers[targetIdx] = computeCenters([kept[targetIdx]])[0]; }
    }

    var note = "CNA " + (absentIdx+1) + " left early ‚Äî redistributed " + give.length + " patient(s) across remaining CNAs (" +
      (mode === "least" ? "least workload" : "in order") + (keepClose ? ", nearest rooms" : "") + ", " + (fairnessMode === "soft" ? "soft balance" : "strict balance") + ").";
    return { assignments: kept, labels: labels, note: note };
  }


  // Light load UI events
  if (get("lightToggle")){
    get("lightToggle").addEventListener("click", function(){
      var panel = get("lightPanel");
      if (!panel) return;
      var open = panel.getAttribute("data-open") === "1";
      panel.setAttribute("data-open", open ? "0" : "1");
      saveState();
      renderLightLoad();
    });
  }
  if (get("lightAdd")){
    get("lightAdd").addEventListener("click", function(){
      ensureLightRules();
      var n = parseInt(get("cnaCount").value || "1", 10);
      // pick first CNA not already in rules if possible
      var used = {};
      for (var i=0;i<lightRules.length;i++) used[lightRules[i].cna] = true;
      var pick = 1;
      for (var k=1;k<=n;k++){ if (!used[k]){ pick = k; break; } }
      lightRules.push({ cna: pick, adj: -1 });
      // auto-expand
      var panel = get("lightPanel");
      if (panel) panel.setAttribute("data-open","1");
      saveState();
      renderLightLoad();
    });
  }
  if (get("lightClear")){
    get("lightClear").addEventListener("click", function(){
      lightRules = [];
      ensureCnaAdjust();
      for (var i=0;i<cnaAdjust.length;i++) cnaAdjust[i] = 0;
      saveState();
      renderLightLoad();
      toast("Light load cleared");
    });
  }

get("generate").addEventListener("click", function(){ doGenerate(false); });
  get("shuffleAgain").addEventListener("click", function(){ doGenerate(true); });
  get("printBtn").addEventListener("click", function(){
    updatePrintHeaderMeta(); syncOnePerPage(); window.print();
  });

  get("copyAllBtn").addEventListener("click", copyAll);
  get("copyAllWordBtn").addEventListener("click", copyAllForWord);
  if(get("toggleAllDetailsBtn")) get("toggleAllDetailsBtn").addEventListener("click", toggleAllDetails);
  get("copyObsBtn").addEventListener("click", copyObsOnly);
  get("copyHospBtn").addEventListener("click", copyHospOnly);

  get("applyCoverage").addEventListener("click", function(){
    var sel = get("absentCna");
    var modeSel = get("coverageMode");
    if (!sel || !modeSel || !lastAssignments){ toast("Generate assignments first"); return; }
    var absentNum = parseInt(sel.value || "", 10);
    if (isNaN(absentNum) || absentNum < 1 || absentNum > lastAssignments.length){ toast("Select a CNA"); return; }
    var absentIdx = absentNum - 1;
    var mode = modeSel.value || "order";
    var keepClose = !!(get("keepClose") && get("keepClose").checked);
    var fairnessMode = (get("fairnessMode") && get("fairnessMode").value) ? get("fairnessMode").value : "strict";
    var res = redistributeAfterCnaLeaves(absentIdx, mode, keepClose, fairnessMode);
    if (!res){ toast("Cannot redistribute"); return; }

    // Ensure history exists
    if (!coverageHist || coveragePtr < 0){ initCoverageHistory(); }

    // Apply
    lastAssignments = res.assignments;
    // Keep lastWorkloadSnapshot unchanged (same bed pool), but CNA count effectively reduced.
    lastLabels = res.labels;
    lastNote = res.note || "";
    renderAssignments(res.assignments, res.labels, res.note);
    recalcLoadStats(res.assignments);

    // Add to coverage history
    pushCoverageHistory(lastNote);

    get("printBtn").disabled = false;
    get("copyAllBtn").disabled = false;
    get("copyObsBtn").disabled = false;
    get("copyAllWordBtn").disabled = false;

    toast("Coverage updated");
  });

  if (get("coverageUndo")) get("coverageUndo").addEventListener("click", function(){
    if (!coverageHist || coveragePtr <= 0) return;
    coveragePtr -= 1;
    restoreCoverageAt(coveragePtr);
    toast("Coverage undo");
  });

  if (get("coverageRedo")) get("coverageRedo").addEventListener("click", function(){
    if (!coverageHist || coveragePtr >= coverageHist.length - 1) return;
    coveragePtr += 1;
    restoreCoverageAt(coveragePtr);
    toast("Coverage redo");
  });

  if (get("coverageClear")) get("coverageClear").addEventListener("click", function(){
    if (!coverageHist || coveragePtr <= 0) return;
    var ok = confirm("Clear coverage changes and go back to the last generated assignments?");
    if (!ok) return;
    coveragePtr = 0;
    restoreCoverageAt(coveragePtr);
    toast("Coverage cleared");
  });



  get("copyIncludeObs").addEventListener("change", saveState);
  get("copyPageBreaks").addEventListener("change", saveState);

  get("filterMode").addEventListener("change", function(){
    renderRoomList();
    renderRoomEditor();
    saveState();
  });
  get("cnaCount").addEventListener("change", function(){ renderLightLoad(); saveState(); updateChips(); refreshCoverageControls(); });

  get("printDate").addEventListener("change", saveState);
  get("printShift").addEventListener("change", saveState);
  get("onePerPage").addEventListener("change", function(){ syncOnePerPage(); saveState(); });
  get("printRoomList").addEventListener("change", function(){
    if (lastAssignments){ renderAssignments(lastAssignments, lastLabels, lastNote); renderObsSummary(); }
    saveState();
  });

  // Global legend buttons
  get("legendAO").addEventListener("click", function(){
    pushHistory();
    for (var i=0;i<ALL_BEDS.length;i++){ bedStatus[ALL_BEDS[i]] = "Occupied"; bedObsGroup[ALL_BEDS[i]] = "Unassigned"; }
    renderRoomList(); renderRoomEditor(); updateChips(); saveState(); if (lastAssignments) renderObsSummary();
  });
  get("legendAE").addEventListener("click", function(){
    pushHistory();
    for (var i=0;i<ALL_BEDS.length;i++){ bedStatus[ALL_BEDS[i]] = "Empty"; bedObsGroup[ALL_BEDS[i]] = "Unassigned"; }
    renderRoomList(); renderRoomEditor(); updateChips(); saveState(); if (lastAssignments) renderObsSummary();
  });
  get("legendAObs").addEventListener("click", function(){
    pushHistory();
    for (var i=0;i<ALL_BEDS.length;i++){ bedStatus[ALL_BEDS[i]] = "On Observation"; }
    renderRoomList(); renderRoomEditor(); updateChips(); saveState(); if (lastAssignments) renderObsSummary();
  });
  get("legendAAdm").addEventListener("click", function(){
    pushHistory();
    for (var i=0;i<ALL_BEDS.length;i++){ bedStatus[ALL_BEDS[i]] = "Pending Admission"; bedObsGroup[ALL_BEDS[i]] = "Unassigned"; }
    renderRoomList(); renderRoomEditor(); updateChips(); saveState(); if (lastAssignments) renderObsSummary();
  });

  // Room quick buttons
  get("roomOcc").addEventListener("click", function(){
    pushHistory();
    setRoomStatus(selectedRoom, "Occupied");
    renderRoomList(); renderRoomEditor(); updateChips(); saveState(); if (lastAssignments) renderObsSummary();
  });
  get("roomEmpty").addEventListener("click", function(){
    pushHistory();
    setRoomStatus(selectedRoom, "Empty");
    renderRoomList(); renderRoomEditor(); updateChips(); saveState(); if (lastAssignments) renderObsSummary();
  });
  get("roomObs").addEventListener("click", function(){
    pushHistory();
    setRoomStatus(selectedRoom, "On Observation");
    renderRoomList(); renderRoomEditor(); updateChips(); saveState(); if (lastAssignments) renderObsSummary();
  });
  get("roomAdm").addEventListener("click", function(){
    pushHistory();
    setRoomStatus(selectedRoom, "Pending Admission");
    renderRoomList(); renderRoomEditor(); updateChips(); saveState(); if (lastAssignments) renderObsSummary();
  });

  // Init UI from saved
  try{
    if (saved && saved.cnaCount){ var n = parseInt(saved.cnaCount,10); if (!isNaN(n)) get("cnaCount").value = n; }
    if (saved && typeof saved.randomizeTotals === "boolean") randomizeTotals = saved.randomizeTotals;
    get("randState").textContent = randomizeTotals ? "ON" : "OFF";

    if (saved && saved.filterMode) get("filterMode").value = saved.filterMode;

    if (saved && saved.printDate) get("printDate").value = saved.printDate;
    setDefaultDateIfEmpty();
    if (saved && saved.printShift) get("printShift").value = saved.printShift;

    if (saved && typeof saved.onePerPage === "boolean") get("onePerPage").checked = saved.onePerPage;
    syncOnePerPage();

    // Print room list (default ON)
    if (saved && typeof saved.printRoomList === "boolean") get("printRoomList").checked = saved.printRoomList;
    else get("printRoomList").checked = true;

    // Print CNA room details (default ON)
    if (saved && typeof saved.printDetails === "boolean") get("printDetails").checked = saved.printDetails;
    else get("printDetails").checked = true;

    // Show Details by default on mobile (default ON)
    if (saved && typeof saved.detailsDefault === "boolean") get("detailsDefault").checked = saved.detailsDefault;
    else get("detailsDefault").checked = true;

    function syncPrintDetails(){
      var off = !(get("printDetails") && get("printDetails").checked);
      document.body.classList.toggle("printNoDetails", off);
    }
    syncPrintDetails();

    get("printDetails").addEventListener("change", function(){ syncPrintDetails(); saveState(); });
    get("detailsDefault").addEventListener("change", function(){
      // Reset per-card overrides so the new default applies everywhere
      cnaCardOpen = [];
      saveState();
      if (lastAssignments) renderAssignments(lastAssignments, lastLabels, lastNote);
    });

    // Ensure correct class right before printing
    window.addEventListener("beforeprint", syncPrintDetails);


    if (saved && typeof saved.copyIncludeObs === "boolean") get("copyIncludeObs").checked = saved.copyIncludeObs;
    if (saved && typeof saved.copyPageBreaks === "boolean") get("copyPageBreaks").checked = saved.copyPageBreaks;

    renderRoomList();
    renderRoomEditor();
    updateChips();
    refreshCoverageControls();
  }catch(e){
    showError("Initialization failed: " + e.message + ". Try refreshing or use the reset instructions.");
  }

})();
</script>
<script>
(function(){
  function isMobile(){ return window.matchMedia && window.matchMedia('(max-width: 760px)').matches; }

  function initTopChipsAutoCollapse(){
    var d = document.getElementById('topChipsDetails');
    var s = document.getElementById('topChipsSummary');
    if (!d || !s) return;

    // Keep the label simple and always visible.
    var label = s.querySelector('.label');
    if (label) label.textContent = 'Shift Stats';

    // Default: show stats at the very top. We'll auto-collapse once the user scrolls down.
    d.setAttribute('open','');

    // If the page loads already scrolled, collapse immediately on mobile.
    if (isMobile() && window.scrollY > 60) d.removeAttribute('open');

    // Smart hide/show on scroll (mobile only):
    // - scrolling down past 80px => collapse
    // - scrolling up => expand (even if not back to the top)
    var lastY = window.scrollY || 0;
    var ticking = false;

    function apply(){
      ticking = false;
      if (!isMobile()) {
        // Desktop: always open
        d.setAttribute('open','');
        lastY = window.scrollY || 0;
        return;
      }

      var y = window.scrollY || 0;
      var delta = y - lastY;

      // Ignore tiny scroll jitter (iOS address bar etc.)
      if (Math.abs(delta) < 8) return;

      if (delta > 0) {
        // Scrolling down: once you scroll past the threshold, collapse.
        if (y > 80) d.removeAttribute('open');
      }
      // Scrolling up does NOT auto-expand; use the Shift Stats button to expand.

      lastY = y;
    }

    window.addEventListener('scroll', function(){
      if (ticking) return;
      ticking = true;
      window.requestAnimationFrame(apply);
    }, {passive:true});

    // If the user rotates/resizes across the breakpoint, normalize state.
    var lastMobile = isMobile();
    window.addEventListener('resize', function(){
      var nowMobile = isMobile();
      if (nowMobile === lastMobile) return;
      lastMobile = nowMobile;
      if (!nowMobile) d.setAttribute('open','');
      else {
        // Entering mobile: if already scrolled down, collapse; otherwise keep current state.
        if (window.scrollY > 60) d.removeAttribute('open');
      }
    }, {passive:true});
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initTopChipsAutoCollapse);
  } else {
    initTopChipsAutoCollapse();
  }
})();
</script>
</div>
</div>
</div>


  <footer class="footerCredit">
    Built, created & maintained by <strong>Arnold Deveney</strong>
    <span class="mini">Catered Cottage ‚Äî CNA Assignment Generator</span>
  </footer>


<script>
/* Disable "Include full room list (Room # checklist)" feature without breaking the app */
(function(){
  function disableRoomChecklist(){
    var cb = document.getElementById('printRoomList');
    if (cb){ cb.checked = false; }
    // If the original code uses a function, override it safely
    try { window.isPrintRoomListOn = function(){ return false; }; } catch(e){}
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', disableRoomChecklist);
  } else {
    disableRoomChecklist();
  }
})();
</script>


<script>
(function(){
  function forceSpreadOff(){
    try{
      var el=document.getElementById("spreadRooms");
      if(el){ el.checked=false; }
    }catch(e){}
  }
  document.addEventListener("DOMContentLoaded", forceSpreadOff);
})();
</script>


<script>
(function(){
  function applyLogoBackground(){
    try{
      var logoDiv = document.querySelector('#printHeader .phLogo');
      if(!logoDiv) return;
      var img = logoDiv.querySelector('img');
      if(!img || !img.src) return;
      logoDiv.style.backgroundImage = "url('" + img.src + "')";
    }catch(e){}
  }
  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", applyLogoBackground);
  }else{
    applyLogoBackground();
  }
})();
</script>


<!-- Mobile quick actions (Generate / Shuffle / Print) -->
<div id="mobileActionBar" class="mobileActionBar" aria-label="Quick actions">
  <button type="button" id="mGenerate" class="mBtn mPrimary">Generate</button>
  <button type="button" id="mShuffle" class="mBtn mGhost" disabled>Shuffle</button>
  <button type="button" id="mPrint" class="mBtn mGhost" disabled>Print</button>
</div>

<script>
// === Mobile action bar wiring ===
(function(){
  function byId(id){ return document.getElementById(id); }
  function syncMobileButtons(){
    var gen = byId('generate');
    var sh  = byId('shuffleAgain');
    var pr  = byId('printBtn');
    var mGen = byId('mGenerate');
    var mSh  = byId('mShuffle');
    var mPr  = byId('mPrint');
    if(!gen || !sh || !pr || !mGen || !mSh || !mPr) return;
    mSh.disabled = !!sh.disabled;
    mPr.disabled = !!pr.disabled;
  }
  function wire(){
    var gen = byId('generate');
    var sh  = byId('shuffleAgain');
    var pr  = byId('printBtn');
    var mGen = byId('mGenerate');
    var mSh  = byId('mShuffle');
    var mPr  = byId('mPrint');
    if(!gen || !sh || !pr || !mGen || !mSh || !mPr) return;
    mGen.addEventListener('click', function(){ gen.click(); });
    mSh.addEventListener('click', function(){ sh.click(); });
    mPr.addEventListener('click', function(){ pr.click(); });
    // keep state synced (after generate enables shuffle/print)
    setInterval(syncMobileButtons, 300);
    syncMobileButtons();
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', wire);
  }else{
    wire();
  }
})();
</script>
</body>
</html>
